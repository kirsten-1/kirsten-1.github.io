<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 Hilda 的个人博客，与你一起发现更大的世界 | 要做一个有 swag 的程序员">
    <meta name="keywords" content="Hilda">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="numpy(10)NumPy的扩展：SciPy - Hilda的博客 | Your genius girlfriend's blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="

">
    
    <meta property="article:published_time" content=" 2025-02-14T00:00:00Z">
    
    
    <meta property="article:author" content="Hilda">
    
    
    <meta property="article:tag" content="人工智能AI基础">
    
    
    <meta property="og:image" content="https://kirsten-1.github.io">
    <meta property="og:url" content="https://kirsten-1.github.io/2025/02/14/NumPy(10)NumPy%E7%9A%84%E6%89%A9%E5%B1%95-SciPy/">
    <meta property="og:site_name" content="Hilda的博客 | Your genius girlfriend's blog">

    <title>numpy(10)NumPy的扩展：SciPy - Hilda的博客 | Your genius girlfriend's blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://kirsten-1.github.io/2025/02/14/NumPy(10)NumPy%E7%9A%84%E6%89%A9%E5%B1%95-SciPy/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Hilda</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg');
        background: ;
    }

    
</style>




<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BDAI%E5%9F%BA%E7%A1%80" title="人工智能AI基础">人工智能AI基础</a>
                        
                    </div>
                    <h1>numpy(10)NumPy的扩展：SciPy</h1>
                    
                    <h2 class="subheading">第 10 章 NumPy 的扩展：SciPy</h2>
                    <span class="meta">Posted by Hilda on February 14, 2025</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG">
</script>

<p>前8章以及其他补充已经整理如下：</p>

<p><a href="https://kirsten-1.github.io/2025/01/27/numpy(1)_%E5%85%A5%E9%97%A8/">第1章NumPy入门</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/04/numpy(2)_numpy%E5%9F%BA%E7%A1%80/">第2章NumPy基础</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/06/Numpy(3)%E5%B8%B8%E7%94%A8%E5%87%BD%E6%95%B0/">第3章常用函数</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/04/Numpy%E7%9A%84%E5%B9%BF%E6%92%AD%E5%92%8C%E5%B9%BF%E6%92%AD%E6%9C%BA%E5%88%B6/">【补充1】-广播与广播机制</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/07/NumPy(4)%E4%BE%BF%E6%8D%B7%E5%87%BD%E6%95%B0/">第4章便捷函数</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/09/NumPy(5)%E7%9F%A9%E9%98%B5%E5%92%8C%E9%80%9A%E7%94%A8%E5%87%BD%E6%95%B0/">第5章矩阵和通用函数</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/09/NumPy(6)%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0NumPy%E6%A8%A1%E5%9D%97/">第6章深入学习NumPy模块</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/10/NumPy(7)%E4%B8%93%E7%94%A8%E5%87%BD%E6%95%B0/">第7章专用函数</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/12/NumPy(8)%E8%B4%A8%E9%87%8F%E6%8E%A7%E5%88%B6/">第8章质量控制</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/12/NumPy(9)%E4%BD%BF%E7%94%A8Matplotlib%E7%BB%98%E5%9B%BE/">第9章使用Matplotlib绘图</a></p>

<p><a href="https://kirsten-1.github.io/2025/02/11/jupyter-notebook-%E8%AF%BB%E5%9B%BE%E7%89%87/">【补充2】-读图片-jupyter notebook-三种方式+图像简单操作</a></p>

<hr />

<p>SciPy是世界著名的Python开源科学计算库，建立在NumPy之上。它增加的功能包括数值积分、最优化、统计和一些专用函数。很多有一些<strong>高阶抽象和物理模型</strong>需要使用 Scipy。</p>

<p>本章涵盖以下内容：</p>

<ul>
  <li>文件输入/输出；</li>
  <li>统计；</li>
  <li>信号处理；</li>
  <li>最优化；</li>
  <li>插值；</li>
  <li>图像和音频处理。</li>
</ul>

<hr />

<h1 id="101-matlab-和-octave">10.1 MATLAB 和 Octave</h1>

<p>MATLAB以及其开源替代品Octave都是流行的数学工具。<code class="language-plaintext highlighter-rouge">scipy.io</code>包的函数可以在Python中加载或保存MATLAB和Octave的矩阵和数组。<code class="language-plaintext highlighter-rouge">loadmat</code>函数可以加载<code class="language-plaintext highlighter-rouge">.mat</code>文件。<code class="language-plaintext highlighter-rouge">savemat</code>函数可以将数组和指定的变量名字典保存为<code class="language-plaintext highlighter-rouge">.mat</code>文件。</p>

<h1 id="102-动手实践保存和加载mat-文件">10.2 动手实践：保存和加载.mat 文件</h1>

<p>如果我们一开始使用了NumPy数组，随后希望在MATLAB或Octave环境中使用这些数组，那么最简单的办法就是创建一个<code class="language-plaintext highlighter-rouge">.mat</code>文件，然后在MATLAB或Octave中加载这个文件。请完成如下步骤。</p>

<p>(1) 创建NumPy数组并调用<code class="language-plaintext highlighter-rouge">savemat</code>创建一个<code class="language-plaintext highlighter-rouge">.mat</code>文件。该函数有两个参数——一个文件名和一个包含变量名和取值的字典。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">io</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">savemat</span><span class="p">(</span><span class="sh">"</span><span class="s">a.mat</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">array</span><span class="sh">'</span><span class="p">:</span> <span class="n">a</span><span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 在MATLAB或Octave环境中加载.mat文件，并检查数组中存储的元素。</p>

<blockquote>
  <p>因为我已经卸载matlab，此处以加载这个文件作为检查。</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">loadmat</span><span class="p">(</span><span class="sh">"</span><span class="s">a.mat</span><span class="sh">"</span><span class="p">)</span>
<span class="n">data</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212223326552.png" alt="image-20250212223326552" style="zoom:50%;" /></p>

<p>文件已经正常加载，发现就是存储的ndarray。</p>

<p>刚才做了些什么 ：我们使用NumPy代码创建了一个<code class="language-plaintext highlighter-rouge">.mat文件</code>并检查了之前创建的NumPy数组的元素。</p>

<p>完整代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">io</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">io</span><span class="p">.</span><span class="nf">savemat</span><span class="p">(</span><span class="sh">"</span><span class="s">a.mat</span><span class="sh">"</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">array</span><span class="sh">'</span><span class="p">:</span> <span class="n">a</span><span class="p">})</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">loadmat</span><span class="p">(</span><span class="sh">"</span><span class="s">a.mat</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212223505573.png" alt="image-20250212223505573" style="zoom:50%;" /></p>

<h2 id="突击测验加载mat类型的文件">突击测验：加载.mat类型的文件</h2>

<p>问题1 以下哪个函数可以加载.mat类型的文件？</p>

<p>(1) Loadmatlab
(2) loadmat
(3) loadoct
(4) frommat</p>

<blockquote>
  <p>答案：（2）loadmat，其余都不是一个有效的 Python 函数</p>
</blockquote>

<h1 id="103-统计">10.3 统计</h1>

<p>SciPy的统计模块是<code class="language-plaintext highlighter-rouge">scipy.stats</code>，其中有一个类是连续分布的实现，一个类是离散分布的实现。此外，该模块中还有很多用于统计检验的函数。</p>

<h1 id="104-动手实践分析随机数">10.4 动手实践：分析随机数</h1>

<p>我们将按正态分布生成随机数，并使用<code class="language-plaintext highlighter-rouge">scipy.stats</code>包中的统计函数分析生成的数据。请完成如下步骤。</p>

<p>(1) 使用<code class="language-plaintext highlighter-rouge">scipy.stats</code>包按正态分布生成随机数。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="n">generated</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">900</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 用正态分布去拟合生成的数据，得到其均值和标准差：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">generatedrated</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>均值和标准差如下所示：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212223946959.png" alt="image-20250212223946959" style="zoom:50%;" /></p>

<p>(3) 偏度（skewness）描述的是概率分布的偏斜（非对称）程度。我们来做一个偏度检验。该检验有两个返回值，其中第二个返回值为p-value，即观察到的数据集服从正态分布的概率，取值范围为0~1。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">skewtest</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>偏度检验返回的结果如下：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212224332833.png" alt="image-20250212224332833" style="zoom:50%;" /></p>

<p>因此，该数据集有79%的概率服从正态分布。</p>

<blockquote>
  <p>注：不同的随机数生成，会导致这里不同的<code class="language-plaintext highlighter-rouge">pvalue</code>值。</p>
</blockquote>

<p>(4) 峰度（kurtosis）描述的是概率分布曲线的陡峭程度。我们来做一个峰度检验。该检验与偏度检验类似，当然这里是针对峰度。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">kurtosistest</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212230552246.png" alt="image-20250212230552246" style="zoom:50%;" /></p>

<p>(5) 正态性检验（normality test）可以检查数据集服从正态分布的程度。我们来做一个正态性检验。该检验同样有两个返回值，其中第二个返回值为p-value。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">normaltest</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212230647435.png" alt="image-20250212230647435" style="zoom:50%;" /></p>

<p>(6) 使用SciPy我们可以很方便地得到数据所在的区段中某一百分比处的数值：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">scoreatpercentile</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">95</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212230735236.png" alt="image-20250212230735236" style="zoom:50%;" /></p>

<p>(7) 将前一步反过来，我们也可以从数值1出发找到对应的百分比：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">percentileofscore</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212230820613.png" alt="image-20250212230820613" style="zoom:50%;" /></p>

<p>(8) 使用Matplotlib绘制生成数据的分布直方图。有关Matplotlib的详细介绍可以在前一章中 找到。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212230926924.png" alt="image-20250212230926924" style="zoom:50%;" /></p>

<p>刚才做了些什么 : 我们按正态分布生成了一个随机数据集，并使用<code class="language-plaintext highlighter-rouge">scipy.stats</code>模块分析了该数据集。</p>

<p>完整代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">generated</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="mi">900</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">skewtest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">kurtosistest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">normaltest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">scoreatpercentile</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">95</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="nf">percentileofscore</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="勇敢出发改进数据生成">勇敢出发：改进数据生成</h2>

<p>从本节中的直方图来看，数据生成仍有改进的空间。尝试使用NumPy或调节<code class="language-plaintext highlighter-rouge">scipy.stats.norm.rvs</code>函数的参数。</p>

<p>直方图看起来像一个 <strong>标准正态分布</strong>（均值=0，标准差=1），但可以尝试一些改进：</p>

<ol>
  <li><strong>增加样本数量</strong> 以使分布更加平滑。</li>
  <li><strong>使用 <code class="language-plaintext highlighter-rouge">numpy.random.normal</code> 生成数据</strong>，并尝试调整均值 (<code class="language-plaintext highlighter-rouge">loc</code>) 和标准差 (<code class="language-plaintext highlighter-rouge">scale</code>)。</li>
  <li><strong>调整 <code class="language-plaintext highlighter-rouge">scipy.stats.norm.rvs</code> 的 <code class="language-plaintext highlighter-rouge">loc</code> 和 <code class="language-plaintext highlighter-rouge">scale</code> 参数</strong>，生成不同的正态分布。</li>
</ol>

<h3 id="优化方案-1增加样本数量"><strong>优化方案 1：增加样本数量</strong></h3>

<p>当前 <code class="language-plaintext highlighter-rouge">size=900</code>，可以增加到 <strong>5000 或更多</strong> 以获得更平滑的分布：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">generated</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>  <span class="c1"># 增加样本数量
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212231440453.png" alt="image-20250212231440453" style="zoom:50%;" /></p>

<h3 id="优化方案-2使用-numpy-生成数据"><strong>优化方案 2：使用 NumPy 生成数据</strong></h3>

<p>使用 <code class="language-plaintext highlighter-rouge">numpy.random.normal()</code> 代替 <code class="language-plaintext highlighter-rouge">stats.norm.rvs()</code>，并调整 <strong>均值 (<code class="language-plaintext highlighter-rouge">loc</code>) 和 标准差 (<code class="language-plaintext highlighter-rouge">scale</code>)</strong>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">generated</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>  <span class="c1"># 调整均值和标准差
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212231542313.png" alt="image-20250212231542313" style="zoom:50%;" /></p>

<h3 id="优化方案-3调整-scipystatsnormrvs-的参数"><strong>优化方案 3：调整 <code class="language-plaintext highlighter-rouge">scipy.stats.norm.rvs</code> 的参数</strong></h3>

<p>你可以尝试 <strong>不同的 <code class="language-plaintext highlighter-rouge">loc</code> 和 <code class="language-plaintext highlighter-rouge">scale</code> 值</strong> 来调整分布的形状：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">generated</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>  <span class="c1"># 右偏移，增加方差
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212231618321.png" alt="image-20250212231618321" style="zoom:50%;" /></p>

<p>参考完整代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">matplotlib.font_manager</span> <span class="k">as</span> <span class="n">fm</span>


<span class="c1"># 解决中文显示问题
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">font.sans-serif</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">STHeiti</span><span class="sh">'</span><span class="p">]</span>  <span class="c1"># 指定黑体
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">axes.unicode_minus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>   <span class="c1"># 解决负号 "-" 显示为方块的问题
# 生成更平滑的正态分布数据
</span><span class="n">generated</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>

<span class="c1"># 统计分析
</span><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">拟合参数 (均值, 标准差):</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">norm</span><span class="p">.</span><span class="nf">fit</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">偏度检验:</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">skewtest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">峰度检验:</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">kurtosistest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">正态性检验:</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">normaltest</span><span class="p">(</span><span class="n">generated</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">95% 分位数:</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">scoreatpercentile</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">95</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">得分1的百分位:</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">percentileofscore</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1"># 绘制更平滑的直方图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">generated</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">b</span><span class="sh">'</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">改进后的正态分布直方图</span><span class="sh">"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250212232052630.png" alt="image-20250212232052630" style="zoom:50%;" /></p>

<h1 id="105-样本比对和-scikits">10.5 样本比对和 SciKits</h1>

<p>我们经常会遇到两组数据样本，它们可能来自不同的实验，但互相有一些关联。统计检验可以进行样本比对。</p>

<p><code class="language-plaintext highlighter-rouge">scipy.stats</code>模块中已经实现了部分统计检验。</p>

<p>另一种笔者喜欢的统计检验是<code class="language-plaintext highlighter-rouge">scikits.statsmodels.stattools</code>中的<code class="language-plaintext highlighter-rouge">Jarque-Bera</code>正态性检验。</p>

<p>SciKits是Python的小型实验工具包，它并不是SciPy的一部分。</p>

<p>此外还有pandas（Python Data Analysis Library），它是scikits.statsmodels的分支。</p>

<p>你可以访问https://scikits.appspot.com/scikits查阅SciKits的模块索引。</p>

<p>你可以使用setuptools安装statsmodels，命令如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">easy_install</span> <span class="n">statsmodels</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="106-动手实践比较股票对数收益率">10.6 动手实践：比较股票对数收益率</h1>

<p>我们将使用Matplotlib下载一年以来的两只股票的数据。如同前面的章节中所述，我们可以从雅虎财经频道获取股价数据。我们将比较DIA和SPY收盘价的对数收益率。我们还将在两只股票对数收益率的差值上应用<code class="language-plaintext highlighter-rouge">Jarque-Bera</code>正态性检验。请完成如下步骤。</p>

<p>(1) 编写一个函数<code class="language-plaintext highlighter-rouge">get_close</code>，用于返回指定股票的收盘价数据。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>

<span class="k">def</span> <span class="nf">get_close</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
    <span class="c1"># 获取今天的日期
</span>    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

    <span class="c1"># 获取去年的日期作为开始日期
</span>    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

    <span class="c1"># 使用 yfinance 获取历史股市数据
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># display(data)
</span>    <span class="c1"># 提取收盘价和成交量并确保它们是一维数组
</span>    <span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
</span>    <span class="k">return</span> <span class="n">close</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>例如：<code class="language-plaintext highlighter-rouge">AAPL</code>代表苹果的股票：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">get_close</span><span class="p">(</span><span class="sh">'</span><span class="s">AAPL</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213141637665.png" alt="image-20250213141637665" style="zoom:50%;" /></p>

<p>经过测试，书上的DIA和SPY都是可以获取收盘价的。目前这两只股票是有效的。</p>

<p>(2) 计算DIA和SPY的对数收益率。先对收盘价取自然对数，然后计算连续值之间的差值，即得到对数收益率。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">dia</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">get_close</span><span class="p">(</span><span class="sh">'</span><span class="s">DIA</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">spy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">get_close</span><span class="p">(</span><span class="sh">'</span><span class="s">SPY</span><span class="sh">'</span><span class="p">)))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(3) 均值检验可以检查两组不同的样本是否有相同的均值。返回值有两个，其中第二个为p-value，取值范围为0~1。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">stats</span><span class="p">.</span><span class="nf">ttest_ind</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="n">spy</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213142320110.png" style="zoom:50%;" /></p>

<p>因此有77.7%的概率两组样本对数收益率的均值相同。</p>

<h2 id="补充scipystatsttest_ind">补充：<code class="language-plaintext highlighter-rouge">scipy.stats.ttest_ind</code></h2>

<p><code class="language-plaintext highlighter-rouge">scipy.stats.ttest_ind</code> 是 SciPy 库中的一个函数，用于进行 <strong>独立样本 t 检验</strong>（Independent T-test），通常用于比较两个独立样本的均值是否存在显著差异。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">scipy</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">ttest_ind</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="sh">'</span><span class="s">propagate</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>参数：</p>

<p><code class="language-plaintext highlighter-rouge">a</code> : array_like</p>

<ul>
  <li>第一个样本的数据（1D 或 2D 数组）。它可以是一个包含多个观测值的一维数组，也可以是多个组的二维数组。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">b</code> : array_like</p>

<ul>
  <li>第二个样本的数据，与 <code class="language-plaintext highlighter-rouge">a</code> 参数相同，表示第二组样本。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">axis</code> : int, optional, default 0</p>

<ul>
  <li>指定沿哪个轴进行操作。如果输入是二维数据，<code class="language-plaintext highlighter-rouge">axis=0</code> 表示在每列进行比较；<code class="language-plaintext highlighter-rouge">axis=1</code> 表示在每行进行比较。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">equal_var</code> : bool, optional, default True</p>

<ul>
  <li>是否假设两个样本具有相同的方差。默认为 True，表示进行 <strong>标准的 t 检验</strong>。如果设为 False，则进行 <strong>Welch’s t-test</strong>，该检验不假定两个样本具有相同的方差。</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">nan_policy</code> : {‘propagate’, ‘raise’, ‘omit’}, optional, default ‘propagate’</p>

<ul>
  <li>处理 NaN 值的策略：
    <ul>
      <li><code class="language-plaintext highlighter-rouge">'propagate'</code>: 如果输入包含 NaN，返回 NaN。</li>
      <li><code class="language-plaintext highlighter-rouge">'raise'</code>: 如果输入包含 NaN，抛出 <code class="language-plaintext highlighter-rouge">ValueError</code> 异常。</li>
      <li><code class="language-plaintext highlighter-rouge">'omit'</code>: 忽略 NaN 值，计算时不包括包含 NaN 的值。</li>
    </ul>
  </li>
</ul>

<p>返回值：该函数返回两个值：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">statistic</code>: t 值，表示检验统计量。</li>
  <li><code class="language-plaintext highlighter-rouge">pvalue</code>: p 值，用于判断均值差异是否显著。如果 p 值小于显著性水平（例如 0.05），则可以拒绝原假设，认为两个样本的均值存在显著差异。</li>
</ul>

<hr />

<p>(4) Kolmogorov-Smirnov检验可以判断两组样本同分布的可能性。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">判断两组样本同分布</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">ks_2samp</span><span class="p">(</span><span class="n">spy</span><span class="p">,</span> <span class="n">dia</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213142533040.png" alt="image-20250213142533040" style="zoom:50%;" /></p>

<p>同样，该函数有两个返回值，其中第二个为p-value。</p>

<hr />

<h2 id="补充statsks_2samp">补充：<code class="language-plaintext highlighter-rouge">stats.ks_2samp</code></h2>

<p><code class="language-plaintext highlighter-rouge">scipy.stats.ks_2samp</code> 是 SciPy 库中的一个函数，用于进行 <strong>Kolmogorov-Smirnov 双样本检验</strong>（KS 2-sample test）。该检验用于比较两个独立样本是否来自相同的分布。它基于两个样本的经验分布函数（ECDF，Empirical Cumulative Distribution Function）之间的最大差异。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">scipy</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">ks_2samp</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="sh">'</span><span class="s">two-sided</span><span class="sh">'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="sh">'</span><span class="s">auto</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>参数：</p>

<p><strong>x1</strong> : array_like</p>

<ul>
  <li>第一个样本的数据。可以是 1D 数组或类似的序列类型。</li>
</ul>

<p><strong>x2</strong> : array_like</p>

<ul>
  <li>第二个样本的数据。类型同 <code class="language-plaintext highlighter-rouge">x1</code>。</li>
</ul>

<p><strong>alternative</strong> : {‘two-sided’, ‘less’, ‘greater’}, optional, default ‘two-sided’</p>

<ul>
  <li>检验的方向：
    <ul>
      <li><code class="language-plaintext highlighter-rouge">'two-sided'</code>: 双尾检验（默认），检验两个样本是否来自不同的分布。</li>
      <li><code class="language-plaintext highlighter-rouge">'less'</code>: 单尾检验，检验 <code class="language-plaintext highlighter-rouge">x1</code> 的分布是否“较小”。</li>
      <li><code class="language-plaintext highlighter-rouge">'greater'</code>: 单尾检验，检验 <code class="language-plaintext highlighter-rouge">x1</code> 的分布是否“较大”。</li>
    </ul>
  </li>
</ul>

<p><strong>method</strong> : {‘auto’, ‘exact’, ‘asymp’}, optional, default ‘auto’</p>

<ul>
  <li>用于计算检验统计量的方法：
    <ul>
      <li><code class="language-plaintext highlighter-rouge">'auto'</code>: 根据样本大小自动选择方法。</li>
      <li><code class="language-plaintext highlighter-rouge">'exact'</code>: 使用精确的方法进行计算。</li>
      <li><code class="language-plaintext highlighter-rouge">'asymp'</code>: 使用渐近方法（对于大样本有效）。</li>
    </ul>
  </li>
</ul>

<p>返回值：</p>

<p><strong>statistic</strong> : float</p>

<ul>
  <li>Kolmogorov-Smirnov 统计量，表示两个样本的经验分布函数之间的最大差异。</li>
</ul>

<p><strong>pvalue</strong> : float</p>

<ul>
  <li>p 值，表示在原假设下，得到当前或更极端统计量的概率。较小的 p 值表示拒绝原假设，即认为两个样本的分布有显著差异。</li>
</ul>

<hr />

<p>(5) 在两只股票对数收益率的差值上应用Jarque-Bera正态性检验。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">正态性检验：</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">jarque_bera</span><span class="p">(</span><span class="n">spy</span> <span class="o">-</span> <span class="n">dia</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213143532102.png" alt="image-20250213143532102" style="zoom:50%;" /></p>

<p><strong>非常小的 p 值</strong>（比如上面的 <code class="language-plaintext highlighter-rouge">1.09e-17</code>）表明，<strong>拒绝原假设的证据非常强</strong>。也就是说，样本数据不符合正态分布的可能性极大。可能样本数据的偏度（skewness）和峰度（kurtosis）与正态分布存在较大差异。<strong>Jarque-Bera 检验</strong> 结合了样本的 <strong>偏度</strong> 和 <strong>峰度</strong>，如果这两个值偏离正态分布的期望（0 的偏度，3 的峰度），检验统计量会较大，从而导致 p 值非常小。</p>

<h2 id="补充scikitsstatsjarque_bera">补充：<code class="language-plaintext highlighter-rouge">scikits.stats.jarque_bera</code></h2>

<p>安装<code class="language-plaintext highlighter-rouge">scikits</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">sys</span>
<span class="err">!</span><span class="p">{</span><span class="n">sys</span><span class="p">.</span><span class="n">executable</span><span class="p">}</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">scikits</span><span class="p">.</span><span class="n">stats</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>安装会报错：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">Defaulting</span> <span class="n">to</span> <span class="n">user</span> <span class="n">installation</span> <span class="n">because</span> <span class="n">normal</span> <span class="n">site</span><span class="o">-</span><span class="n">packages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">writeable</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">Could</span> <span class="ow">not</span> <span class="n">find</span> <span class="n">a</span> <span class="n">version</span> <span class="n">that</span> <span class="n">satisfies</span> <span class="n">the</span> <span class="n">requirement</span> <span class="n">scikits</span><span class="p">.</span><span class="nf">stats </span><span class="p">(</span><span class="k">from</span> <span class="n">versions</span><span class="p">:</span> <span class="n">none</span><span class="p">)</span>
<span class="n">ERROR</span><span class="p">:</span> <span class="n">No</span> <span class="n">matching</span> <span class="n">distribution</span> <span class="n">found</span> <span class="k">for</span> <span class="n">scikits</span><span class="p">.</span><span class="n">stats</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>由于 <code class="language-plaintext highlighter-rouge">scikits.stats</code> 库不再被维护和更新，因此无法通过 <code class="language-plaintext highlighter-rouge">pip install scikits.stats</code> 安装它。</p>

<p><strong><code class="language-plaintext highlighter-rouge">scikits.stats</code></strong> 库的 <strong><code class="language-plaintext highlighter-rouge">jarque_bera</code></strong> 检验已经被移除或者不再更新，且没有提供新的版本用于安装。这是一个不再维护的第三方库，不能通过 pip 安装。</p>

<p>解决：<strong>使用 SciPy 的 <code class="language-plaintext highlighter-rouge">jarque_bera</code> 检验：</strong> 当前 <strong>SciPy</strong> 已经包含了 <strong>Jarque-Bera 检验</strong>，你可以直接使用 <code class="language-plaintext highlighter-rouge">scipy.stats.jarque_bera</code> 函数来进行正态性检验。这样你就不需要依赖 <code class="language-plaintext highlighter-rouge">scikits.stats</code> 库了。</p>

<hr />

<p><code class="language-plaintext highlighter-rouge">scipy.stats.jarque_bera</code> 是 SciPy 库中的一个函数，用于进行 <strong>Jarque-Bera 正态性检验</strong>，它是检验样本数据是否符合正态分布的一种方法。该检验基于样本的偏度（skewness）和峰度（kurtosis），并计算出一个统计量和对应的 p 值。</p>

<p>函数签名：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">scipy</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="nf">jarque_bera</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>参数：<strong>x</strong> : array_like</p>

<ul>
  <li>要检验的样本数据，通常是一个一维数组或者列表。</li>
</ul>

<p>返回值：</p>

<p><strong>statistic</strong> : float</p>

<ul>
  <li>Jarque-Bera 检验的统计量，表示数据的偏度和峰度偏差。</li>
</ul>

<p><strong>pvalue</strong> : float</p>

<ul>
  <li>p 值，表示在原假设下，得到当前或更极端的统计量的概率。较小的 p 值（如小于 0.05）表明数据可能不符合正态分布。</li>
</ul>

<hr />

<p>(6) 使用Matplotlib绘制对数收益率以及其差值的直方图。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">spy</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">SPY</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">DIA</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">spy</span> <span class="o">-</span> <span class="n">dia</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Delta</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213143925099.png" alt="image-20250213143925099" style="zoom:50%;" /></p>

<p>刚才做了些什么 ：我们比较了DIA和SPY样本数据的对数收益率，还对它们的差值应用了Jarque-Bera正态性检验。</p>

<p>完整代码如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="k">def</span> <span class="nf">get_close</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
    <span class="c1"># 获取今天的日期
</span>    <span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

    <span class="c1"># 获取去年的日期作为开始日期
</span>    <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

    <span class="c1"># 使用 yfinance 获取历史股市数据
</span>    <span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="c1"># display(data)
</span>    <span class="c1"># 提取收盘价和成交量并确保它们是一维数组
</span>    <span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
</span>    <span class="k">return</span> <span class="n">close</span>

<span class="n">dia</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">get_close</span><span class="p">(</span><span class="sh">'</span><span class="s">DIA</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">spy</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">diff</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">get_close</span><span class="p">(</span><span class="sh">'</span><span class="s">SPY</span><span class="sh">'</span><span class="p">)))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">t检验：</span><span class="sh">"</span><span class="p">,</span><span class="n">stats</span><span class="p">.</span><span class="nf">ttest_ind</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="n">spy</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">判断两组样本同分布</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">ks_2samp</span><span class="p">(</span><span class="n">spy</span><span class="p">,</span> <span class="n">dia</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">正态性检验：</span><span class="sh">"</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="nf">jarque_bera</span><span class="p">(</span><span class="n">spy</span> <span class="o">-</span> <span class="n">dia</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># 绘图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">spy</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">SPY</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">dia</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">DIA</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">spy</span> <span class="o">-</span> <span class="n">dia</span><span class="p">,</span> <span class="n">histtype</span><span class="o">=</span><span class="sh">"</span><span class="s">step</span><span class="sh">"</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">Delta</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<h1 id="107-信号处理">10.7 信号处理</h1>

<p><code class="language-plaintext highlighter-rouge">scipy.signal</code>模块中包含滤波函数和B样条插值（B-spline interpolation）函数。</p>

<blockquote>
  <p>样条插值使用称为样条的多项式进行插值。插值过程将分段多项式连接起来拟合数据。B样条是样条的一种类型。</p>
</blockquote>

<h2 id="补充样条插值">补充：样条插值</h2>

<p>样条插值：一种以 可变样条 来作出一条经过一系列点的光滑曲线的数学方法。插值样条是由一些多项式组成的，每一个多项式都是由相邻的两个数据点决定的，这样，任意的两个相邻的多项式以及它们的导数在连接点处都是连续的。</p>

<p>简单理解，就是每两个点之间确定一个函数，这个函数就是一个样条，函数不同，样条就不同。所以定义中说 可变样条，然后把所有样条分段结合成一个函数，就是最终的插值函数。</p>

<h3 id="线性样条">线性样条</h3>

<p>两点确定一条直线，我们可以在每两点间画一条直线，就可以把所有点连起来。显然曲线不够光滑，究其原因是因为连接点处导数不相同。</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213145910580.png" alt="image-20250213145910580" style="zoom:50%;" /></p>

<h3 id="二次样条">二次样条</h3>

<p>直线不行，用曲线代替，二次函数是最简单的曲线。</p>

<p>假设4个点，\(x_0，x_1，x_2，x_3\)，有3个区间，需要3个二次样条，每个二次样条为 \(ax^2+bx+c\)，故总计9个未知数。</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213150009697.png" alt="image-20250213150009697" style="zoom:50%;" /></p>

<ol>
  <li>
    <p>x0，x3两个端点都有一个二次函数经过，可确定2个方程</p>
  </li>
  <li>
    <p>x1，x2两个中间点都有两个二次函数经过，可确定4个方程</p>
  </li>
  <li>
    <p>中间点处必须连续，需要保证左右二次函数一阶导相等，即　\(2*a_1*x_1+b_1=2*a_2*x_1+b_2\)和\(2*a_2*x_2+b_2=2*a_3*x_2+b_3\)，可确定2个方程，此时共有了8个方程。</p>
  </li>
  <li>
    <p>这里假设第一方程的二阶导为0，即 \(a_1=0\)，又是一个方程，共计9个方程。　　　</p>

    <blockquote>
      <p>为什么？端点可以有多种不同的限制，常见有3种。</p>

      <ul>
        <li>自由边界 Natural</li>
      </ul>

      <p>首尾两端没有受到任何使他们弯曲的力，二次样条就是 \(s’=0\)，三次样条就是 \(s''=0\)。这种边界条件简洁且自然，通常用于描述物理上没有约束的情况。就像一个柔软的线条，两端没有被固定或拉紧，所以两端的弯曲是自由的。</p>

      <ul>
        <li>固定边界 Clamped</li>
      </ul>

      <p>首尾两端点的微分值被指定，这种边界条件比较强，适用于需要控制端点斜率的情况，比如力学问题中的物体位置和运动的约束。</p>

      <ul>
        <li>非节点边界 Not-A-Knot</li>
      </ul>

      <p>把端点当做中间点处理，三次函数不做假设，即</p>

      <p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213151359842.png" alt="image-20250213151359842" style="zoom:50%;" /></p>

      <p>即 <strong>端点与相邻内点之间的连续性不做额外假设</strong>。在三次样条中，非节点边界要求两个端点之间的 <strong>第三阶导数</strong> 也连续。</p>

      <p>上面假设\(a_1 = 0\)，表示该区间的样条是线性的（即没有二次项），这可以与 <strong>自然边界条件</strong> 中 <strong>二阶导数为零</strong> 的情形相关。这相当于对样条函数的平滑性进行约束，并且它为你的方程组增加了 <strong>1 个额外的约束</strong>，使得你有 <strong>9 个方程</strong>，正好可以求解 <strong>9 个未知数</strong>。简单理解，就是8个方程解9个未知数解不了，加个方程就可以了，此时最简单的假设就是\(a_1 = 0\)。</p>
    </blockquote>

    <p>上面9个方程联立即可求解9个未知数。</p>

    <p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213152700596.png" style="zoom:50%;" /></p>

    <p>二次样条插值连续光滑，只是前两个点之间是条直线，因为假设\(a_1 = 0\)，二次函数变成\(b_1x+c_1\)，显然是直线；</p>

    <p>而且最后两个点之间过于陡峭 。</p>

    <h4 id="代码">代码</h4>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
</pre></td><td class="rouge-code"><pre><span class="c1"># encoding:utf-8
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">pylab</span> <span class="kn">import</span> <span class="n">mpl</span>
<span class="sh">"""</span><span class="s">
二次样条实现
</span><span class="sh">"""</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
   
<span class="c1"># 解决中文显示问题
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">font.sans-serif</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">STHeiti</span><span class="sh">'</span><span class="p">]</span>  <span class="c1"># 指定华文黑体
</span><span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">axes.unicode_minus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>   <span class="c1"># 解决负号 "-" 显示为方块的问题
</span>   
<span class="k">def</span> <span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1">#parameter为二维数组，用来存放参数，sizeOfInterval是用来存放区间的个数
</span>    <span class="n">parameter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sizeOfInterval</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#首先输入方程两边相邻节点处函数值相等的方程为2n-2个方程
</span>    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">data1</span> <span class="o">=</span><span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">data1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">#输入端点处的函数值。为两个方程,加上前面的2n-2个方程，一共2n个方程
</span>    <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="c1">#端点函数值相等为n-1个方程。加上前面的方程为3n-1个方程,最后一个方程为a1=0总共为3n个方程
</span>    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="mi">1</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span><span class="o">=-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mi">1</span>
        <span class="n">temp</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">parameter</span>
   
<span class="sh">"""</span><span class="s">
对一个size大小的元组初始化为0
</span><span class="sh">"""</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">data</span>
   
   
<span class="sh">"""</span><span class="s">
功能：计算样条函数的系数。
参数：parametes为方程的系数，y为要插值函数的因变量。
返回值：二次插值函数的系数。
</span><span class="sh">"""</span>
   
<span class="k">def</span> <span class="nf">solutionOfEquation</span><span class="p">(</span><span class="n">parametes</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">sizeOfInterval</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">3</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sizeOfInterval</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">result</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">solve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
   
<span class="sh">"""</span><span class="s">
功能：根据所给参数，计算二次函数的函数值：
参数:parameters为二次函数的系数，x为自变量
返回值：为函数的因变量
</span><span class="sh">"""</span>
<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">paremeters</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">data_x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">data_x</span><span class="o">*</span><span class="n">data_x</span><span class="o">+</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">data_x</span><span class="o">+</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span>  <span class="n">result</span>
   
   
<span class="sh">"""</span><span class="s">
功能：将函数绘制成图像
参数：data_x,data_y为离散的点.new_data_x,new_data_y为由拉格朗日插值函数计算的值。x为函数的预测值。
返回值：空
</span><span class="sh">"""</span>
<span class="k">def</span>  <span class="nf">Draw</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span><span class="n">data_y</span><span class="p">,</span><span class="n">new_data_x</span><span class="p">,</span><span class="n">new_data_y</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">new_data_x</span><span class="p">,</span> <span class="n">new_data_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">u</span><span class="sh">"</span><span class="s">拟合曲线</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span><span class="n">data_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">u</span><span class="sh">"</span><span class="s">离散数据</span><span class="sh">"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">font.sans-serif</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">STHeiti</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">axes.unicode_minus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">u</span><span class="sh">"</span><span class="s">二次样条函数</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">upper left</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
   
<span class="n">result</span><span class="o">=</span><span class="nf">solutionOfEquation</span><span class="p">(</span><span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">)</span>
<span class="n">new_data_x1</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y1</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">new_data_x1</span><span class="p">)</span>
<span class="n">new_data_x2</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y2</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span><span class="n">new_data_x2</span><span class="p">)</span>
<span class="n">new_data_x3</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y3</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span><span class="n">new_data_x3</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="o">=</span><span class="p">[]</span>
<span class="n">new_data_y</span><span class="o">=</span><span class="p">[]</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x1</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x2</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x3</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y1</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y2</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y3</span><span class="p">)</span>
<span class="nc">Draw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">new_data_x</span><span class="p">,</span><span class="n">new_data_y</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213152700596.png" alt="image-20250213152700596" style="zoom:50%;" /></p>
  </li>
</ol>

<h3 id="三次样条">三次样条</h3>

<p>二次函数最高项系数为0，导致变成直线，那三次函数最高项系数为0，还是曲线，插值效果应该更好。</p>

<p>三次样条思路与二次样条基本相同，</p>

<p>同样假设4个点，\(x_0，x_1，x_2，x_3\)，有3个区间，需要3个三次样条，每个三次样条为 \(ax^3+bx^2+cx+d\)，故总计12个未知数。</p>

<ol>
  <li>
    <p>内部节点处的函数值应该相等，这里一共是4个方程。</p>
  </li>
  <li>
    <p>函数的第一个端点和最后一个端点，应该分别在第一个方程和最后一个方程中。这里是2个方程。</p>
  </li>
  <li>
    <p>两个函数(即中间两个点)在节点处的一阶导数应该相等。这里是两个方程。</p>
  </li>
  <li>
    <p>两个函数(即中间两个点)在节点处的二阶导数应该相等，这里是两个方程。　　　　</p>
  </li>
  <li>
    <p>假设端点处的二阶导数（二阶导是\(3ax^2+2bx+c\)）为零，这里是两个方程。　　　\(a_1=0\) ，\(b_1=0\)</p>
  </li>
</ol>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213153333445.png" alt="image-20250213153333445" style="zoom:50%;" /></p>

<h4 id="代码-1">代码</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
</pre></td><td class="rouge-code"><pre><span class="c1"># encoding:utf-8
</span><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">pylab</span> <span class="kn">import</span> <span class="n">mpl</span>
<span class="sh">"""</span><span class="s">
三次样条实现
</span><span class="sh">"""</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1">#parameter为二维数组，用来存放参数，sizeOfInterval是用来存放区间的个数
</span>    <span class="n">parameter</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sizeOfInterval</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">#首先输入方程两边相邻节点处函数值相等的方程为2n-2个方程
</span>    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">data1</span> <span class="o">=</span><span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data1</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data1</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># 输入端点处的函数值。为两个方程, 加上前面的2n - 2个方程，一共2n个方程
</span>    <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[(</span><span class="n">sizeOfInterval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
    <span class="c1"># 端点函数一阶导数值相等为n-1个方程。加上前面的方程为3n-1个方程。
</span>    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sizeOfInterval</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># 端点函数二阶导数值相等为n-1个方程。加上前面的方程为4n-2个方程。且端点处的函数值的二阶导数为零，为两个方程。总共为4n个方程。
</span>    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">parameter</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">parameter</span>



<span class="sh">"""</span><span class="s">
对一个size大小的元组初始化为0
</span><span class="sh">"""</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">:</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="sh">"""</span><span class="s">
功能：计算样条函数的系数。
参数：parametes为方程的系数，y为要插值函数的因变量。
返回值：三次插值函数的系数。
</span><span class="sh">"""</span>
<span class="k">def</span> <span class="nf">solutionOfEquation</span><span class="p">(</span><span class="n">parametes</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="n">sizeOfInterval</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nf">init</span><span class="p">(</span><span class="n">sizeOfInterval</span><span class="o">*</span><span class="mi">4</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">sizeOfInterval</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
    <span class="n">result</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[(</span><span class="n">sizeOfInterval</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data_x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">data_x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">solve</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="sh">"""</span><span class="s">
功能：根据所给参数，计算三次函数的函数值：
参数:parameters为二次函数的系数，x为自变量
返回值：为函数的因变量
</span><span class="sh">"""</span>
<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">paremeters</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
    <span class="n">result</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">data_x</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">data_x</span><span class="o">*</span><span class="n">data_x</span><span class="o">*</span><span class="n">data_x</span><span class="o">+</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">data_x</span><span class="o">*</span><span class="n">data_x</span><span class="o">+</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">data_x</span><span class="o">+</span><span class="n">paremeters</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span>  <span class="n">result</span>


<span class="sh">"""</span><span class="s">
功能：将函数绘制成图像
参数：data_x,data_y为离散的点.new_data_x,new_data_y为由拉格朗日插值函数计算的值。x为函数的预测值。
返回值：空
</span><span class="sh">"""</span>
<span class="k">def</span>  <span class="nf">Draw</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span><span class="n">data_y</span><span class="p">,</span><span class="n">new_data_x</span><span class="p">,</span><span class="n">new_data_y</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">new_data_x</span><span class="p">,</span> <span class="n">new_data_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">u</span><span class="sh">"</span><span class="s">拟合曲线</span><span class="sh">"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">black</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">data_x</span><span class="p">,</span><span class="n">data_y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">u</span><span class="sh">"</span><span class="s">离散数据</span><span class="sh">"</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="sh">"</span><span class="s">red</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">font.sans-serif</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">STHeiti</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">'</span><span class="s">axes.unicode_minus</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sa">u</span><span class="sh">"</span><span class="s">三次样条函数</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="sh">"</span><span class="s">upper left</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>


<span class="n">result</span><span class="o">=</span><span class="nf">solutionOfEquation</span><span class="p">(</span><span class="nf">calculateEquationParameters</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">y</span><span class="p">)</span>
<span class="n">new_data_x1</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y1</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">new_data_x1</span><span class="p">)</span>
<span class="n">new_data_x2</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y2</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">5</span><span class="p">]],</span><span class="n">new_data_x2</span><span class="p">)</span>
<span class="n">new_data_x3</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">new_data_y3</span><span class="o">=</span><span class="nf">calculate</span><span class="p">([</span><span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">]],</span><span class="n">new_data_x3</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="o">=</span><span class="p">[]</span>
<span class="n">new_data_y</span><span class="o">=</span><span class="p">[]</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x1</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x2</span><span class="p">)</span>
<span class="n">new_data_x</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_x3</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y1</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y2</span><span class="p">)</span>
<span class="n">new_data_y</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="n">new_data_y3</span><span class="p">)</span>
<span class="nc">Draw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">new_data_x</span><span class="p">,</span><span class="n">new_data_y</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<hr />

<p>SciPy中以一组数值来定义信号。我们以detrend函数作为滤波器的一个例子。该函数可以对信号进行线性拟合，然后从原始输入数据中去除这个线性趋势。</p>

<h1 id="108-动手实践检测-qqq-股价的线性趋势">10.8 动手实践：检测 QQQ 股价的线性趋势</h1>

<p>相比于去除数据样本的趋势，我们通常更关心的是趋势本身。在去除趋势的操作之后，我们仍然很容易获取该趋势。我们将对QQQ一年以来的股价数据进行这些处理分析。</p>

<p>(1) 编写代码获取QQQ的收盘价和对应的日期数据。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>

<span class="c1"># 获取今天的日期
</span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="c1"># 获取去年的日期作为开始日期
</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

<span class="c1"># 使用有效的股票符号（例如苹果公司AAPL）
</span><span class="n">symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">QQQ</span><span class="sh">'</span>

<span class="c1"># 使用 yfinance 获取历史股市数据
</span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># display(data)
# 提取日期和收盘价并确保它们是一维数组
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
</span><span class="nf">display</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="nf">display</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 去除信号中的线性趋势。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">signal</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="nf">detrend</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213154348790.png" alt="image-20250213154348790" style="zoom:50%;" /></p>

<p>(3) 创建月定位器和日定位器。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">matplotlib.dates</span> <span class="kn">import</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">DayLocator</span><span class="p">,</span> <span class="n">MonthLocator</span>

<span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator </span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(4) 创建一个日期格式化器以格式化x轴上的日期。该格式化器将创建一个字符串，包含简写的月份和年份。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(5) 创建图像和子图。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(6) 绘制股价数据以及将去除趋势后的信号从原始数据中减去所得到的潜在趋势。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">close</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213154806807.png" alt="image-20250213154806807" style="zoom:50%;" /></p>

<p>(7) 设置定位器和格式化器。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_minor_locator</span><span class="p">(</span><span class="n">alldays</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_locator</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">month_formatter</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213154839926.png" alt="image-20250213154839926" style="zoom:50%;" /></p>

<p>(8) 将x轴上的标签格式化为日期。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># 自动旋转日期标签
</span><span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span>

<span class="c1"># 显示图形
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最终效果：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213154921159.png" alt="image-20250213154921159" style="zoom:50%;" /></p>

<p>刚才做了些什么 :  我们绘制了QQQ的收盘价数据以及对应的趋势线。</p>

<p>完整代码如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="n">matplotlib.dates</span> <span class="kn">import</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">DayLocator</span><span class="p">,</span> <span class="n">MonthLocator</span>

<span class="c1"># 获取今天的日期
</span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="c1"># 获取去年的日期作为开始日期
</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

<span class="c1"># 使用有效的股票符号（例如苹果公司AAPL）
</span><span class="n">symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">QQQ</span><span class="sh">'</span>

<span class="c1"># 使用 yfinance 获取历史股市数据
</span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># display(data)
# 提取日期和收盘价并确保它们是一维数组
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
# display(dates)
# display(close)
</span> 
<span class="c1"># 去除信号中的线性趋势
</span><span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="nf">detrend</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>

<span class="c1"># 定位器
</span><span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator </span><span class="p">()</span> 
<span class="c1"># 格式化器
</span><span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span> 

<span class="c1"># 创建图像和子图
</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">close</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">close</span> <span class="o">-</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">)</span>

<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_minor_locator</span><span class="p">(</span><span class="n">alldays</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_locator</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">month_formatter</span><span class="p">)</span> 

<span class="c1"># 自动旋转日期标签
</span><span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span>

<span class="c1"># 显示图形
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="109-傅里叶分析">10.9 傅里叶分析</h1>

<p>现实世界中的信号往往具有周期性。傅里叶变换（Fourier transform）是处理这些信号的常用工具。傅里叶变换是一种从时域到频域的变换，也就是将周期信号线性分解为不同频率的正弦和余弦函数。</p>

<p>傅里叶变换的函数可以在<code class="language-plaintext highlighter-rouge">scipy.fftpack</code>模块中找到（NumPy也有自己的傅里叶工具包，即<code class="language-plaintext highlighter-rouge">numpy.fft</code>）。这个模块包含快速傅里叶变换、微分算子和拟微分算子以及一些辅助函数。MATLAB用户会很高兴，因为<code class="language-plaintext highlighter-rouge">scipy.fftpack</code>模块中的很多函数与MATLAB对应的函数同名，且功能也很相近。</p>

<blockquote>
  <p>注：在 <code class="language-plaintext highlighter-rouge">scipy</code> 中，傅立叶变换相关的模块是 <code class="language-plaintext highlighter-rouge">scipy.fft</code>，而不是 <code class="language-plaintext highlighter-rouge">scipy.fftpack</code>。</p>

  <p>具体来说，<code class="language-plaintext highlighter-rouge">scipy.fftpack</code> 是旧版的傅立叶变换模块，已经被 <code class="language-plaintext highlighter-rouge">scipy.fft</code> 取代。<code class="language-plaintext highlighter-rouge">scipy.fft</code> 提供了更现代和高效的接口，并且是推荐使用的模块。</p>

  <p>在代码中使用的是 <code class="language-plaintext highlighter-rouge">scipy.fftpack</code>，建议迁移到 <code class="language-plaintext highlighter-rouge">scipy.fft</code>，因为后者在新版本的 <code class="language-plaintext highlighter-rouge">scipy</code> 中得到了更好的支持和优化。</p>
</blockquote>

<h1 id="1010-动手实践对去除趋势后的信号进行滤波处理">10.10 动手实践：对去除趋势后的信号进行滤波处理</h1>

<p>在10.8节我们学习了如何去除信号中的趋势。</p>

<p>去除趋势后的信号可能有周期性的分量，我们将其显现出来。一些步骤已在前面的“动手实践”教程中出现过，如下载数据和设置Matplotlib 对象。这些步骤将被略去。</p>

<p>(1) 应用傅里叶变换，得到信号的频谱。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 滤除噪声。如果某一频率分量的大小低于最强分量的10%，则将其滤除。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">amps</span><span class="p">[</span><span class="n">amps</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">amps</span><span class="p">.</span><span class="nf">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213160814748.png" alt="image-20250213160814748" style="zoom:50%;" /></p>

<p>(3) 将滤波后的信号变换回时域，并和去除趋势后的信号一起绘制出来。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">detrended</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="o">-</span><span class="n">fft</span><span class="p">.</span><span class="nf">irfft</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">ifftshift</span><span class="p">(</span><span class="n">amps</span><span class="p">)),</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">filtered</span><span class="sh">"</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>那么，效果就是：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213163639544.png" alt="image-20250213163639544" style="zoom:50%;" /></p>

<p>此时，还没有自动旋转日期标签，所以日期显示是这样。</p>

<p>(4) 将x轴上的标签格式化为日期，并添加一个特大号的图例。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># 自动旋转日期标签
</span><span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span>
<span class="c1"># 添加一个特大的图例
</span><span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213163746326.png" alt="image-20250213163746326" style="zoom:50%;" /></p>

<p>(5) 添加第二个子图，绘制滤波后的频谱。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span> 
<span class="n">ax2</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">amps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">transformed</span><span class="sh">"</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>此时报错了：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">ValueError</span><span class="p">:</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span> <span class="n">must</span> <span class="n">have</span> <span class="n">same</span> <span class="n">first</span> <span class="n">dimension</span><span class="p">,</span> <span class="n">but</span> <span class="n">have</span> <span class="nf">shapes </span><span class="p">(</span><span class="mi">251</span><span class="p">,)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">126</span><span class="p">,)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这个错误是由于 <code class="language-plaintext highlighter-rouge">plt.plot(np.linspace(-N/2, N/2, N), amps, label="transformed")</code> 中，<code class="language-plaintext highlighter-rouge">amps</code> 和 <code class="language-plaintext highlighter-rouge">np.linspace(-N/2, N/2, N)</code> 的长度不一致。具体来说，<code class="language-plaintext highlighter-rouge">amps</code> 的长度是通过 <code class="language-plaintext highlighter-rouge">rfft</code> 获得的，而 <code class="language-plaintext highlighter-rouge">rfft</code> 的输出频谱是比输入信号的长度少一半的（加一）。</p>

<p>解决：</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">amps</code> 和频率轴的长度不匹配</strong>：由于使用的是 <code class="language-plaintext highlighter-rouge">rfft</code>，其结果长度为 <code class="language-plaintext highlighter-rouge">len(y) // 2 + 1</code>。需要调整频率轴，使它与 <code class="language-plaintext highlighter-rouge">amps</code> 的长度一致。</li>
  <li><strong>频率轴的长度</strong>：在绘制频谱图时，<code class="language-plaintext highlighter-rouge">amps</code> 和频率轴（<code class="language-plaintext highlighter-rouge">np.linspace(-N/2, N/2, N)</code>）的长度应当一致。</li>
</ol>

<p>修改后代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># N = len(close) 
# plt.plot(np.linspace(-N/2, N/2, N), amps, label="transformed") 
# 计算频率轴，并确保它和amps的长度一致
</span><span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># 使用y的长度来生成频率轴
</span><span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">amps</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 从0到Nyquist频率
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>然后绘制第二幅图，即频谱图：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c1"># 绘制频谱图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">transformed</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>效果：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213165144177.png" alt="image-20250213165144177" style="zoom:50%;" /></p>

<blockquote>
  <p>不建议第一幅图<code class="language-plaintext highlighter-rouge">labelsize</code>太大，否则横轴的日期信息会被遮挡。</p>
</blockquote>

<p>最终完整代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span><span class="n">signal</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>
<span class="kn">from</span> <span class="n">matplotlib.dates</span> <span class="kn">import</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">DayLocator</span><span class="p">,</span> <span class="n">MonthLocator</span>

<span class="c1"># 获取今天的日期
</span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="c1"># 获取去年的日期作为开始日期
</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

<span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator</span><span class="p">()</span> 
<span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span> 

<span class="c1"># 使用有效的股票符号
</span><span class="n">symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">QQQ</span><span class="sh">'</span>

<span class="c1"># 使用 yfinance 获取历史股市数据
</span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># display(data)
# 提取日期和收盘价并确保它们是一维数组
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
# print(len(dates))
# print(len(close))
</span> 
<span class="c1"># 去除信号中的线性趋势
</span><span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="nf">detrend</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>  
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span> 


<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_minor_locator</span><span class="p">(</span><span class="n">alldays</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_locator</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">month_formatter</span><span class="p">)</span> 

<span class="c1"># 调大字号 
</span><span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-small</span><span class="sh">'</span><span class="p">)</span> 

<span class="c1"># 傅里叶变换，得到信号的频谱
</span><span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> 
<span class="c1"># 滤除噪声。如果某一频率分量的大小低于最强分量的10%，则将其滤除。 
</span><span class="n">amps</span><span class="p">[</span><span class="n">amps</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">amps</span><span class="p">.</span><span class="nf">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="c1"># 将滤波后的信号变换回时域，并和去除趋势后的信号一起绘制出来。  
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">detrended</span><span class="sh">"</span><span class="p">)</span> 
<span class="c1"># plt.plot(dates, -fft.irfft(fft.ifftshift(amps)), label="filtered") 
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_filtered</span><span class="p">,</span> <span class="n">filtered_signal</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">filtered</span><span class="sh">"</span><span class="p">)</span> 

<span class="c1"># 自动旋转日期标签
</span><span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span>
<span class="c1"># 添加一个特大的图例
</span><span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span>
<span class="c1"># 添加第二个子图，绘制滤波后的频谱
</span><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span> 
<span class="n">ax2</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">)</span>  
<span class="c1"># N = len(close) 
# plt.plot(np.linspace(-N/2, N/2, N), amps, label="transformed") 
# 计算频率轴，并确保它和amps的长度一致
</span><span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># 使用y的长度来生成频率轴
</span><span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">amps</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 从0到Nyquist频率
</span>
<span class="c1"># 绘制频谱图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">transformed</span><span class="sh">"</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="1011-数学优化">10.11 数学优化</h1>

<p>优化算法（optimization algorithm）尝试寻求某一问题的最优解，例如找到函数的最大值或最小值，函数可以是线性或者非线性的。解可能有一些特定的约束，例如不允许有负数。在<code class="language-plaintext highlighter-rouge">scipy.optimize</code>模块中提供了一些优化算法，最小二乘法函数leastsq就是其中之一。当调用这个函数时，我们需要提供一个<strong>残差（误差项）</strong>函数。这样，leastsq将最小化残差的平方和。得到的解与我们使用的数学模型有关。我们还需要为算法提供一个起始点，这应该是一个最好的猜测——尽可能接近真实解。否则，程序执行800轮迭代后将停止。</p>

<h1 id="1012-动手实践拟合正弦波">10.12 动手实践：拟合正弦波</h1>

<p>在10.10节中，我们为去除趋势后的数据创建了一个简单的滤波器。现在，我们使用一个限制性更强的滤波器，只保留主频率部分。我们将拟合一个正弦波并绘制结果。该模型有4个参数—— 振幅、频率、相位和垂直偏移。请完成如下步骤。</p>

<p>(1) 根据正弦波模型，定义residuals函数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  
    <span class="n">A</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span> 
    <span class="n">err</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>  
    <span class="k">return</span> <span class="n">err</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 将滤波后的信号变换回时域：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">fft</span>

<span class="n">filtered</span> <span class="o">=</span> <span class="o">-</span><span class="n">fft</span><span class="p">.</span><span class="nf">irfft</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">ifftshift</span><span class="p">(</span><span class="n">amps</span><span class="p">))</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(3) 猜测参数的值，尝试估计从时域到频域的变换函数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c1"># 获取今天的日期
</span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="c1"># 获取去年的日期作为开始日期
</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

<span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator</span><span class="p">()</span> 
<span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span> 

<span class="c1"># 使用有效的股票符号
</span><span class="n">symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">QQQ</span><span class="sh">'</span>

<span class="c1"># 使用 yfinance 获取历史股市数据
</span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># display(data)
# 提取日期和收盘价并确保它们是一维数组
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
</span>
<span class="c1"># 猜测参数的值，尝试估计从时域到频域的变换函数
</span><span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> 
<span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> 
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">filtered</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="n">f</span><span class="p">[</span><span class="n">amps</span><span class="p">.</span><span class="nf">argmax</span><span class="p">()]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">P0</span><span class="sh">"</span><span class="p">,</span> <span class="n">p0</span> <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250213165747993.png" alt="image-20250213165747993" style="zoom:50%;" /></p>

<p>(4) 调用leastsq函数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="c1"># 下面的步骤的意义：修改dates的类型，否则传入residuals函数，会无法和k相乘
# 将日期转换为 pandas 的 DatetimeIndex 类型
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="c1"># 将日期转换为天数（相对于第一个日期）
</span><span class="n">date_numeric</span> <span class="o">=</span> <span class="p">(</span><span class="n">dates</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">days</span>

<span class="c1"># 确保 filtered 和 date_numeric 数组的长度一致,否则optimize.leastsq还是会报错
</span><span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">date_numeric</span><span class="p">):</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[:</span><span class="nf">len</span><span class="p">(</span><span class="n">date_numeric</span><span class="p">)]</span>
<span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">date_numeric</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">):</span>
    <span class="n">date_numeric</span> <span class="o">=</span> <span class="n">date_numeric</span><span class="p">[:</span><span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)]</span>
<span class="nf">print</span><span class="p">(</span><span class="n">filtered</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span><span class="n">date_numeric</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># 输出：(250,) (250,)
</span>
<span class="c1"># 调用leastsq函数
</span><span class="n">plsq</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">.</span><span class="nf">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span><span class="n">date_numeric</span><span class="p">))</span>  
<span class="n">p</span> <span class="o">=</span> <span class="n">plsq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>代码比书上的多，是因为现在依赖更新了，处理方式也会有区别。</p>
</blockquote>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214125015053.png" alt="image-20250214125015053" style="zoom:50%;" /></p>

<p>(5) 在第一个子图中绘制去除趋势后的数据、滤波后的数据及其拟合曲线。将x轴格式化为日期，并添加一个图例。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator</span><span class="p">()</span> 
<span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>  
<span class="n">fig</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>  
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span> 

<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_minor_locator</span><span class="p">(</span><span class="n">alldays</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_locator</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">month_formatter</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">date_numeric</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_251</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">detrended</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">filtered</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">date_numeric</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="sh">'</span><span class="s">^</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">fit</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>注，此处我又对数据（日期数据）进行了处理：</p>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">dates_251</span> <span class="o">=</span> <span class="n">dates</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[:</span><span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)]</span>
<span class="n">dates_</span> <span class="o">=</span> <span class="n">dates</span>  <span class="c1"># 长度250
# 下面的步骤的意义：修改dates的类型，否则传入residuals函数，会无法和k相乘
# 将日期转换为 pandas 的 DatetimeIndex 类型
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="c1"># 将日期转换为天数（相对于第一个日期）
</span><span class="n">date_numeric</span> <span class="o">=</span> <span class="p">(</span><span class="n">dates</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">days</span>
</pre></td></tr></tbody></table></code></pre></div>  </div>
</blockquote>

<p>(6) 添加第二个子图，绘制主频率部分的频谱图和图例。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="c1"># 第2张子图
</span><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span> 
<span class="n">ax2</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">)</span>  
<span class="c1"># 这里调整 f 数组的长度与 amps 一致，否则画图会报错
</span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">fft</span><span class="p">.</span><span class="nf">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">days</span><span class="p">)[:</span><span class="nf">len</span><span class="p">(</span><span class="n">amps</span><span class="p">)]</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">transformed</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">size</span><span class="sh">'</span><span class="p">:</span><span class="sh">'</span><span class="s">x-large</span><span class="sh">'</span><span class="p">})</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214130735458.png" alt="image-20250214130735458" style="zoom:50%;" /></p>

<p>我建议把图的图例的<code class="language-plaintext highlighter-rouge">x-large</code>都去掉，否则第一幅子图的字都看不清，被遮挡了(或者改成<code class="language-plaintext highlighter-rouge">x-small</code>)，最终完整代码和效果如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">matplotlib.dates</span> <span class="kn">import</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">DayLocator</span><span class="p">,</span> <span class="n">MonthLocator</span>
<span class="kn">import</span> <span class="n">yfinance</span> <span class="k">as</span> <span class="n">yf</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>


<span class="k">def</span> <span class="nf">residuals</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>  
    <span class="n">A</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span> 
    <span class="n">err</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span>  
    <span class="k">return</span> <span class="n">err</span> 

<span class="c1"># 获取今天的日期
</span><span class="n">today</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="c1"># 获取去年的日期作为开始日期
</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">today</span><span class="p">.</span><span class="n">year</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="p">,</span> <span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="p">)</span>

<span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator</span><span class="p">()</span> 
<span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span> 

<span class="c1"># 使用有效的股票符号
</span><span class="n">symbol</span> <span class="o">=</span> <span class="sh">'</span><span class="s">QQQ</span><span class="sh">'</span>

<span class="c1"># 使用 yfinance 获取历史股市数据
</span><span class="n">data</span> <span class="o">=</span> <span class="n">yf</span><span class="p">.</span><span class="nf">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">start</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">year</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">month</span><span class="si">}</span><span class="s">-</span><span class="si">{</span><span class="n">today</span><span class="p">.</span><span class="n">day</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># display(data)
# 提取日期和收盘价并确保它们是一维数组
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>
<span class="n">close</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">].</span><span class="nf">to_numpy</span><span class="p">().</span><span class="nf">flatten</span><span class="p">()</span>  <span class="c1"># 使用 flatten() 确保是一维数组
# print(len(dates))
# print(len(close))
</span> 
<span class="c1"># 去除信号中的线性趋势
</span><span class="n">y</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="nf">detrend</span><span class="p">(</span><span class="n">close</span><span class="p">)</span>

<span class="c1"># 傅里叶变换，得到信号的频谱
</span><span class="n">amps</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">rfft</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span> 
<span class="c1"># 滤除噪声。如果某一频率分量的大小低于最强分量的10%，则将其滤除。 
</span><span class="n">amps</span><span class="p">[</span><span class="n">amps</span> <span class="o">&lt;</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">amps</span><span class="p">.</span><span class="nf">max</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">0</span> 

<span class="c1"># 将滤波后的信号变换回时域
</span><span class="n">filtered</span> <span class="o">=</span> <span class="o">-</span><span class="n">fft</span><span class="p">.</span><span class="nf">irfft</span><span class="p">(</span><span class="n">fft</span><span class="p">.</span><span class="nf">ifftshift</span><span class="p">(</span><span class="n">amps</span><span class="p">))</span> 

<span class="c1"># 猜测参数的值，尝试估计从时域到频域的变换函数
</span><span class="n">N</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> 
<span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> 
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">filtered</span><span class="p">.</span><span class="nf">max</span><span class="p">(),</span> <span class="n">f</span><span class="p">[</span><span class="n">amps</span><span class="p">.</span><span class="nf">argmax</span><span class="p">()]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">P0</span><span class="sh">"</span><span class="p">,</span> <span class="n">p0</span> <span class="p">)</span>  <span class="c1"># 输出：P0 [19.521577364265628, -0.11800000000000001, 0, 0]
</span><span class="n">dates_251</span> <span class="o">=</span> <span class="n">dates</span>
<span class="n">dates</span> <span class="o">=</span> <span class="n">dates</span><span class="p">[:</span><span class="nf">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)]</span>
<span class="n">dates_</span> <span class="o">=</span> <span class="n">dates</span>  <span class="c1"># 长度250
# 下面的步骤的意义：修改dates的类型，否则传入residuals函数，会无法和k相乘
# 将日期转换为 pandas 的 DatetimeIndex 类型
</span><span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">dates</span><span class="p">)</span>
<span class="c1"># print(dates)
# 将日期转换为天数（相对于第一个日期）
</span><span class="n">date_numeric</span> <span class="o">=</span> <span class="p">(</span><span class="n">dates</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">days</span>

<span class="c1"># 调用leastsq函数
</span><span class="n">plsq</span> <span class="o">=</span> <span class="n">optimize</span><span class="p">.</span><span class="nf">leastsq</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span><span class="n">date_numeric</span><span class="p">))</span>  
<span class="n">p</span> <span class="o">=</span> <span class="n">plsq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">P</span><span class="sh">"</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>

<span class="n">alldays</span> <span class="o">=</span> <span class="nc">DayLocator</span><span class="p">()</span>  
<span class="n">months</span> <span class="o">=</span> <span class="nc">MonthLocator</span><span class="p">()</span> 
<span class="n">month_formatter</span> <span class="o">=</span> <span class="nc">DateFormatter</span><span class="p">(</span><span class="sh">"</span><span class="s">%b %Y</span><span class="sh">"</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>  
<span class="n">fig</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>  
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span> 

<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_minor_locator</span><span class="p">(</span><span class="n">alldays</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_locator</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="n">xaxis</span><span class="p">.</span><span class="nf">set_major_formatter</span><span class="p">(</span><span class="n">month_formatter</span><span class="p">)</span> 
<span class="n">ax</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-small</span><span class="sh">'</span><span class="p">)</span>
<span class="c1"># print(date_numeric)
</span><span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_251</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">detrended</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_</span><span class="p">,</span> <span class="n">filtered</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">filtered</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">dates_</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">date_numeric</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="sh">'</span><span class="s">^</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">fit</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">fig</span><span class="p">.</span><span class="nf">autofmt_xdate</span><span class="p">()</span> 
<span class="c1"># plt.legend(prop={'size':'x-large'}) 
</span>
<span class="c1"># 第2张子图
</span><span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span> 
<span class="n">ax2</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">both</span><span class="sh">'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="sh">'</span><span class="s">major</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="sh">'</span><span class="s">x-small</span><span class="sh">'</span><span class="p">)</span>  
<span class="c1"># 这里调整 f 数组的长度与 amps 一致，否则画图会报错
</span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">fft</span><span class="p">.</span><span class="nf">fftfreq</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">days</span><span class="p">)[:</span><span class="nf">len</span><span class="p">(</span><span class="n">amps</span><span class="p">)]</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">amps</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">transformed</span><span class="sh">"</span><span class="p">)</span> 
<span class="c1"># plt.legend(prop={'size':'x-large'})  
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214131007498.png" alt="image-20250214131007498" style="zoom:50%;" /></p>

<p>刚才做了些什么 :  我们对一年以来的QQQ股价数据进行了去趋势处理。然后进行了滤波处理，仅保留了频谱上的主频率部分。我们使用scipy.optimize模块对滤波后的信号拟合了一个正弦波函数。</p>

<h1 id="1013-数值积分">10.13 数值积分</h1>

<p>SciPy中有数值积分的包<code class="language-plaintext highlighter-rouge">scipy.integrate</code>，在NumPy中没有相同功能的包。quad函数可以求单变量函数在两点之间的积分，这些点之间的距离可以是无穷小或无穷大。该函数使用最简单的数值积分方法即梯形法则（trapezoid rule）进行计算。</p>

<h1 id="1014-动手实践计算高斯积分">10.14 动手实践：计算高斯积分</h1>

<p>高斯积分（Gaussian integral）出现在误差函数（数学中记为erf）的定义中，但高斯积分本身的积分区间是无穷的，它的值等于pi的平方根。我们将使用quad函数计算它。</p>

<p>例如，下面都是常见的高斯积分公式。（第一个相信我肯定见过,下面代码计算的应该也是第一个）</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214131243801.png" alt="image-20250214131243801" style="zoom:50%;" /></p>

<p>使用quad函数计算高斯积分。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">integrate</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Gaussian integral</span><span class="sh">"</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">integrate</span><span class="p">.</span><span class="nf">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">)</span> <span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214131446907.png" alt="image-20250214131446907" style="zoom:50%;" /></p>

<p>刚才做了些什么 ：  我们使用quad函数计算了高斯积分。</p>

<h1 id="1015-插值">10.15 插值</h1>

<p>插值（interpolation）即在数据集已知数据点之间“填补空白”。<code class="language-plaintext highlighter-rouge">scipy.interpolate</code>函数可以根据实验数据进行插值。interp1d类可以创建线性插值（linear interpolation）或三次插值（cubic interpolation）的函数。默认将创建线性插值函数，三次插值函数可以通过设置kind参数来创建。interp2d类的工作方式相同，只不过用于二维插值。</p>

<h1 id="1016-动手实践一维插值">10.16 动手实践：一维插值</h1>

<p>我们将使用<code class="language-plaintext highlighter-rouge">sinc</code>函数创建数据点并添加一些随机噪音。随后，我们将进行线性插值和三次插值，并绘制结果。请完成如下步骤。</p>

<p>(1) 创建数据点并添加噪音：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
<span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sinc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(2) 创建一个线性插值函数，并应用于有5倍数据点个数的输入数组：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>

<span class="n">interpreted</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">.</span><span class="nf">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>  
<span class="n">y</span> <span class="o">=</span> <span class="nf">interpreted</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(3) 执行与前一步相同的操作，不过这里使用三次插值。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">cubic</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">.</span><span class="nf">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">cubic</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">y2</span> <span class="o">=</span> <span class="nf">cubic</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(4) 使用Matplotlitb绘制结果。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">linear</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">cubic</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214131933449.png" alt="image-20250214131933449" style="zoom:50%;" /></p>

<p>刚才做了些什么 :  我们用sinc函数创建了一个数据集并加入了噪音，然后使用<code class="language-plaintext highlighter-rouge">scipy.interpolate</code>模块中的interp1d类进行了线性插值和三次插值。</p>

<p>完整代码如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
<span class="n">noise</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">random</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
<span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sinc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span> 
<span class="n">interpreted</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">.</span><span class="nf">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>  
<span class="n">y</span> <span class="o">=</span> <span class="nf">interpreted</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> 
<span class="n">cubic</span> <span class="o">=</span> <span class="n">interpolate</span><span class="p">.</span><span class="nf">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="sh">"</span><span class="s">cubic</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">y2</span> <span class="o">=</span> <span class="nf">cubic</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="sh">'</span><span class="s">o</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">data</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">linear</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">"</span><span class="s">cubic</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="1017-图像处理">10.17 图像处理</h1>

<p>我们可以使用<code class="language-plaintext highlighter-rouge">scipy.ndimage</code>包进行图像处理。该模块包含各种图像滤波器和工具函数。</p>

<h1 id="1018-动手实践处理-lena-图像">10.18 动手实践：处理 Lena 图像</h1>

<p>在<code class="language-plaintext highlighter-rouge">scipy.misc</code>模块中，有一个函数可以载入Lena图像。这幅Lena Soderberg的图像是被用做图像处理的经典示例图像。我们将在该图像上应用一些滤波器，并进行旋转操作。请完成如下步骤。</p>

<blockquote>
  <p>注：<code class="language-plaintext highlighter-rouge">scipy.misc</code> 模块已经不再支持 <code class="language-plaintext highlighter-rouge">lena</code> 图像，它已经被弃用并从 SciPy 版本 1.3.0 开始移除。因此，<code class="language-plaintext highlighter-rouge">misc.lena()</code> 不再有效。</p>

  <p>要解决这个问题，可以直接使用其他方式来加载 Lena 图像。可以使用 <code class="language-plaintext highlighter-rouge">matplotlib</code> 或 <code class="language-plaintext highlighter-rouge">PIL</code>（Python Imaging Library）来加载图像。</p>

  <p>补充：<a href="https://www.eecs.qmul.ac.uk/~phao/IP/Images/">常见的图片库链接（往上随便找的）</a></p>
</blockquote>

<p>(1) 载入Lena图像，并使用灰度颜色表将其在子图中显示出来。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">skimage</span> <span class="kn">import</span> <span class="n">io</span>

<span class="c1"># 从 URL 读取 Lena 图像
</span><span class="n">image_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://www.eecs.qmul.ac.uk/~phao/IP/Images/Lena.bmp</span><span class="sh">'</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

<span class="c1"># 将图像转换为 np.float32
</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># 创建子图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Original Image</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 显示图像（灰度图）
</span><span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span>

<span class="c1"># 显示图像
</span><span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214133352031.png" alt="image-20250214133352031" style="zoom:50%;" /></p>

<p>注意，我们处理的是一个float32类型的数组。</p>

<p>(2) 中值滤波器扫描信号的每一个数据点，并替换为相邻数据点的中值。对图像应用中值滤波器并显示在第二个子图中。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Median Filter</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">filtered</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">median_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">42</span><span class="p">))</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214133513059.png" alt="image-20250214133513059" style="zoom:50%;" /></p>

<p>(3) 旋转图像并显示在第三个子图中。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Rotated</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">rotated</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rotated</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(4) Prewitt滤波器是基于图像强度的梯度计算。对图像应用Prewitt滤波器并显示在第四个子图中。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Prewitt Filter</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">filtered</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">prewitt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214134141236.png" alt="image-20250214134141236" style="zoom:50%;" /></p>

<p>可以看到图片之间距离太小了，标注重叠了。为了解决图像标注重叠的问题，需要调整子图之间的间距。可以通过 <code class="language-plaintext highlighter-rouge">plt.subplots_adjust()</code> 来增加子图之间的空间。这个函数允许调整各个方向上的间距，比如左侧、右侧、上下间距等。</p>

<p>以下是修改后的完整代码和最终效果，增加了子图之间的间距：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">skimage</span> <span class="kn">import</span> <span class="n">io</span>
<span class="kn">from</span> <span class="n">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>

<span class="c1"># 从 URL 读取 Lena 图像
</span><span class="n">image_url</span> <span class="o">=</span> <span class="sh">'</span><span class="s">https://www.eecs.qmul.ac.uk/~phao/IP/Images/Lena.bmp</span><span class="sh">'</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nf">imread</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>

<span class="c1"># 将图像转换为 np.float32
</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>

<span class="c1"># 创建子图
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">221</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Original Image</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># 显示图像（灰度图）
</span><span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span>

<span class="c1"># 显示图像
# plt.show()
</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">222</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Median Filter</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">filtered</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">median_filter</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="mi">42</span><span class="p">))</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span> 

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">223</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Rotated</span><span class="sh">"</span><span class="p">)</span> 
<span class="n">rotated</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">rotate</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">rotated</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span> 

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">224</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Prewitt Filter</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">filtered</span> <span class="o">=</span> <span class="n">ndimage</span><span class="p">.</span><span class="nf">prewitt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">imshow</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">cm</span><span class="p">.</span><span class="n">gray</span><span class="p">)</span>  

<span class="c1"># 调整子图之间的间距
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214134253143.png" alt="image-20250214134253143" style="zoom:50%;" /></p>

<p>刚才做了些什么 : 我们使用<code class="language-plaintext highlighter-rouge">scipy.ndimage</code>模块对Lena图像进行了一些处理操作。</p>

<h1 id="1019-音频处理">10.19 音频处理</h1>

<p>既然我们已经完成了一些图像处理的操作，你可能不会惊讶我们也可以对WAV文件进行处理。我们将下载一个WAV文件并将其重复播放几次。下载音频的部分将被省略，只保留常规的Python代码。</p>

<h1 id="1020-动手实践重复音频片段">10.20 动手实践：重复音频片段</h1>

<p>我们将下载一个WAV文件，来自电影《王牌大贱谍》（Austin Powers）中的一声呼喊：“Smashing，baby!”使用<code class="language-plaintext highlighter-rouge">scipy.io.wavfile</code>模块中的read函数可以将该文件转换为一个NumPy 数组。在本节教程的最后，我们将使用同一模块中的write函数写入一个新的WAV文件。我们将使用tile函数来重复播放音频片段。请完成如下步骤。</p>

<blockquote>
  <p>注意原书的一些依赖已经失效了(包括以下函数的处理细节)。下面展示的是我2025-02-14测试可行的。</p>
</blockquote>

<p>(1) 使用read函数读入文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">scipy.io</span> <span class="kn">import</span> <span class="n">wavfile</span>  
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>  
<span class="kn">import</span> <span class="n">urllib.request</span>  
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>  
<span class="kn">import</span> <span class="n">sys</span> 

<span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlopen</span><span class="p">(</span><span class="sh">'</span><span class="s">http://www.thesoundarchive.com/austinpowers/smashingbaby.wav</span><span class="sh">'</span><span class="p">)</span> 
<span class="nf">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span> <span class="p">)</span>
<span class="n">WAV_FILE</span> <span class="o">=</span> <span class="sh">'</span><span class="s">smashingbaby.wav</span><span class="sh">'</span> 
<span class="n">filehandle</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="n">WAV_FILE</span><span class="p">,</span> <span class="sh">'</span><span class="s">w</span><span class="sh">'</span><span class="p">)</span> 
<span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="n">WAV_FILE</span><span class="p">,</span> <span class="sh">'</span><span class="s">wb</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="n">filehandle</span><span class="p">:</span>
    <span class="n">filehandle</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nf">read</span><span class="p">())</span>  <span class="c1"># 直接写入字节数据
</span>
<span class="c1"># 可以选择读取并处理音频文件，或者做其他操作
</span><span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">WAV_FILE</span><span class="si">}</span><span class="s"> downloaded successfully!</span><span class="sh">"</span><span class="p">)</span>
<span class="n">filehandle</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span> 
<span class="n">sample_rate</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">wavfile</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">WAV_FILE</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Data type</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">dtype</span><span class="p">,</span> <span class="sh">"</span><span class="s">Shape</span><span class="sh">"</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">shape</span> <span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Original</span><span class="sh">"</span> <span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214140335391.png" alt="image-20250214140335391" style="zoom:50%;" /></p>

<p><code class="language-plaintext highlighter-rouge">wavfile.read</code>该函数有两个返回值——采样率和音频数据。在本节教程中，我们只需要用到音频数据。</p>

<p>(2) 应用tile函数：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c1"># 重复音频片段 
# repeated = np.tile(data, int(sys.argv[1])) 
# 重复音频片段 
</span><span class="n">repeated</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">tile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>(3) 使用write函数写入一个新文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">"</span><span class="s">Repeated</span><span class="sh">"</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">repeated</span><span class="p">)</span> 
<span class="n">wavfile</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="sh">"</span><span class="s">repeated_yababy.wav</span><span class="sh">"</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">repeated</span><span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="nf">show </span><span class="p">()</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214140519502.png" alt="image-20250214140519502" style="zoom:50%;" /></p>

<p>再次调整图片间距(在<code class="language-plaintext highlighter-rouge">plt.show()</code>之前)：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="c1"># 调整子图之间的间距
</span><span class="n">plt</span><span class="p">.</span><span class="nf">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>下面是最终效果：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214140630100.png" alt="image-20250214140630100" style="zoom:50%;" /></p>

<p>同时也有这两段wav:</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20250214140655235.png" alt="image-20250214140655235" style="zoom:50%;" /></p>

<p>刚才做了些什么 :  我们读入了一个音频片段，将其重复三遍并将新数组写入了一个新的WAV文件。</p>

<h1 id="1021-本章小结">10.21 本章小结</h1>

<p>在本章中，我们只是触及了SciPy和SciKits的皮毛，学习了一点关于文件输入/输出、统计、信号处理、数学优化、插值以及音频和图像处理的知识。</p>

<p>在下一章中，我们将使用Pygame制作一些简单但有趣的游戏。Pygame是一个开源的Python游戏库。在这个过程中，我们将学习NumPy和Pygame的集成、SciKits机器学习模块以及其他内容。</p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2025/02/12/NumPy(9)%E4%BD%BF%E7%94%A8Matplotlib%E7%BB%98%E5%9B%BE/" data-toggle="tooltip" data-placement="top" title="numpy(9)使用Matplotlib绘图">
                        Previous<br>
                        <span>numpy(9)使用Matplotlib绘图</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2025/02/14/NumPy(11)%E7%8E%A9%E8%BD%ACPygame/" data-toggle="tooltip" data-placement="top" title="numpy(11)玩转 Pygame">
                        Next<br>
                        <span>numpy(11)玩转 Pygame</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0071" 
                    href="/archive/?tag=%E4%B9%A6%E7%B1%8D%E9%98%85%E8%AF%BB"
                    title="书籍阅读"
                    rel="3">书籍阅读</a>
        
                <a data-sort="0053" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="21">算法</a>
        
                <a data-sort="0056" 
                    href="/archive/?tag=%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BDAI%E5%9F%BA%E7%A1%80"
                    title="人工智能AI基础"
                    rel="18">人工智能AI基础</a>
        
                <a data-sort="0062" 
                    href="/archive/?tag=%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%90%B4%E6%81%A9%E8%BE%BE"
                    title="机器学习-吴恩达"
                    rel="12">机器学习-吴恩达</a>
        
                <a data-sort="0065" 
                    href="/archive/?tag=%E5%8A%9B%E6%89%A3"
                    title="力扣"
                    rel="9">力扣</a>
        
                <a data-sort="0072" 
                    href="/archive/?tag=numpy"
                    title="numpy"
                    rel="2">numpy</a>
        
                <a data-sort="0072" 
                    href="/archive/?tag=pandas"
                    title="pandas"
                    rel="2">pandas</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://m.freebuf.com/">freebuf</a></li>
  
  <li><a href="https://xz.aliyun.com/">先知</a></li>
  
  <li><a href="https://www.sec-in.com/All">sec-in</a></li>
  
  <li><a href="https://paper.seebug.org/">see-bug</a></li>
  
  <li><a href="https://twitter.com/Concurr21486093">我的推特</a></li>
  
  <li><a href="https://pdai.tech/">pdai</a></li>
  
  <li><a href="https://nodejs.org/dist/">nodejs index of dist</a></li>
  
  <li><a href="#">公众号：小东方不败</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/Concurr21486093">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/Hilda">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/kirsten-1">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Hilda 2025
                    <br>
                    Powered by <a href="https://kirsten-1.github.io/">hilda Blog</a>
<!--                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"-->
<!--                        height="20px"-->
<!--                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">-->
<!--                    </iframe>-->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
