<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 Hilda 的个人博客，与你一起发现更大的世界 | 要做一个有 swag 的程序员">
    <meta name="keywords" content="Hilda">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="书籍阅读-Python灰帽子–黑客与逆向工程师的Python编程之道 - Hilda的博客 | Your genius girlfriend's blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="&lt;Python灰帽子–黑客与逆向工程师的Python编程之道&gt;
">
    
    <meta property="article:published_time" content=" 2024-05-26T00:00:00Z">
    
    
    <meta property="article:author" content="Hilda">
    
    
    <meta property="article:tag" content="书籍阅读">
    
    
    <meta property="og:image" content="https://kirsten-1.github.io">
    <meta property="og:url" content="https://kirsten-1.github.io/2024/05/26/Python%E7%81%B0%E5%B8%BD%E5%AD%90-%E9%BB%91%E5%AE%A2%E4%B8%8E%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84Python%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01/">
    <meta property="og:site_name" content="Hilda的博客 | Your genius girlfriend's blog">

    <title>书籍阅读-Python灰帽子–黑客与逆向工程师的Python编程之道 - Hilda的博客 | Your genius girlfriend's blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://kirsten-1.github.io/2024/05/26/Python%E7%81%B0%E5%B8%BD%E5%AD%90-%E9%BB%91%E5%AE%A2%E4%B8%8E%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84Python%E7%BC%96%E7%A8%8B%E4%B9%8B%E9%81%93%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B01/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Hilda</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg');
        background: ;
    }

    
</style>




<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E4%B9%A6%E7%B1%8D%E9%98%85%E8%AF%BB" title="书籍阅读">书籍阅读</a>
                        
                    </div>
                    <h1>书籍阅读-Python灰帽子–黑客与逆向工程师的Python编程之道</h1>
                    
                    <h2 class="subheading">Python灰帽子–黑客与逆向工程师的Python编程之道</h2>
                    <span class="meta">Posted by Hilda on May 26, 2024</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="python灰帽子黑客与逆向工程师的python编程之道">&lt;Python灰帽子–黑客与逆向工程师的Python编程之道&gt;</h1>

<p>完整的过程是：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20240926105352242.png" alt="image-20240926105352242" style="zoom:50%;" /></p>

<h2 id="1启动可执行程序createprocessa">1.启动可执行程序<code class="language-plaintext highlighter-rouge">CreateProcessA</code></h2>

<p><code class="language-plaintext highlighter-rouge">CreateProcessA</code>是Windows API中的一个函数，用于创建一个新的进程并启动一个可执行文件。该函数允许你指定新进程的各种属性，如命令行参数、工作目录、环境变量等。<code class="language-plaintext highlighter-rouge">CreateProcessA</code>是<code class="language-plaintext highlighter-rouge">CreateProcess</code>函数的ANSI版本，用于处理ANSI字符串。</p>

<p>函数原型如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">CreateProcessA</span><span class="p">(</span>
  <span class="n">LPCSTR</span>                <span class="n">lpApplicationName</span><span class="p">,</span>  <span class="c1">// 可执行文件的路径</span>
  <span class="n">LPSTR</span>                 <span class="n">lpCommandLine</span><span class="p">,</span>      <span class="c1">// 命令行参数</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpProcessAttributes</span><span class="p">,</span><span class="c1">// 进程安全属性</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpThreadAttributes</span><span class="p">,</span> <span class="c1">// 线程安全属性</span>
  <span class="n">BOOL</span>                  <span class="n">bInheritHandles</span><span class="p">,</span>    <span class="c1">// 是否继承句柄</span>
  <span class="n">DWORD</span>                 <span class="n">dwCreationFlags</span><span class="p">,</span>    <span class="c1">// 创建标志</span>
  <span class="n">LPVOID</span>                <span class="n">lpEnvironment</span><span class="p">,</span>      <span class="c1">// 环境变量</span>
  <span class="n">LPCSTR</span>                <span class="n">lpCurrentDirectory</span><span class="p">,</span> <span class="c1">// 当前目录</span>
  <span class="n">LPSTARTUPINFOA</span>        <span class="n">lpStartupInfo</span><span class="p">,</span>      <span class="c1">// 启动信息</span>
  <span class="n">LPPROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span><span class="c1">// 进程信息</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>书上提及的重要的参数是以下几个：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">lpApplicationName</code></li>
  <li><code class="language-plaintext highlighter-rouge">lpCommandLine</code></li>
  <li><code class="language-plaintext highlighter-rouge">dwCreationFlags</code></li>
  <li><code class="language-plaintext highlighter-rouge">lpStartupInfo</code></li>
  <li><code class="language-plaintext highlighter-rouge">lpProcessInformation</code></li>
</ul>

<h2 id="2定义debuggerdebugger_defines和相关测试程序">2.定义<code class="language-plaintext highlighter-rouge">Debugger</code>,<code class="language-plaintext highlighter-rouge">debugger_defines</code>和相关测试程序</h2>

<p>因为操作系统的不兼容性，所以修改<code class="language-plaintext highlighter-rouge">my_debugger.py</code>，<code class="language-plaintext highlighter-rouge">my_debugger_defines.py</code>以及<code class="language-plaintext highlighter-rouge">my_test.py</code>内容如下：</p>

<p><code class="language-plaintext highlighter-rouge">my_debugger.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*-
# @Date    : 2016-08-11 16:48:16
# @Author  : giantbranch (giantbranch@gmail.com)
# @Link    : http://blog.csdn.net/u012763794?viewmode=contents
</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="n">sys</span>
<span class="kn">import</span> <span class="n">time</span>

<span class="n">libc</span> <span class="o">=</span> <span class="nc">CDLL</span><span class="p">(</span><span class="sh">'</span><span class="s">libc.dylib</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Define ptrace constants for macOS
</span><span class="n">PT_TRACE_ME</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">PT_ATTACH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">PT_CONTINUE</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">PT_READ_D</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">PT_WRITE_D</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">PT_DETACH</span> <span class="o">=</span> <span class="mi">11</span>

<span class="k">class</span> <span class="nc">debugger</span><span class="p">():</span>

    <span class="c1"># 初始化
</span>    <span class="c1"># self参数表示类的实例
</span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">self</span><span class="p">.</span><span class="n">breakpoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">first_breakpoint</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hardware_breakpoints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">self</span><span class="p">.</span><span class="n">guarded_pages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">memory_breakpoints</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 启动程序
</span>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path_to_exe</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="nf">fork</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Child process
</span>            <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_TRACE_ME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">os</span><span class="p">.</span><span class="nf">execv</span><span class="p">(</span><span class="n">path_to_exe</span><span class="p">,</span> <span class="p">[</span><span class="n">path_to_exe</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parent process
</span>            <span class="n">self</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
            <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Process launched with PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 附加
</span>    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Attached to process with PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 运行
</span>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">get_debug_event</span><span class="p">()</span>

    <span class="c1"># 获取调试事件
</span>    <span class="k">def</span> <span class="nf">get_debug_event</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nf">c_int</span><span class="p">()</span>
        <span class="n">libc</span><span class="p">.</span><span class="nf">waitpid</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="nf">byref</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="nf">is_stopped</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">signal_number</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">get_stop_signal</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal_number</span> <span class="o">==</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTRAP</span><span class="p">:</span>
                <span class="n">self</span><span class="p">.</span><span class="nf">handle_breakpoint</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">signal_number</span> <span class="o">==</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGSEGV</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Access Violation Detected.</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Received signal: </span><span class="si">{</span><span class="n">signal_number</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_CONTINUE</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 处理断点
</span>    <span class="k">def</span> <span class="nf">handle_breakpoint</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">first_breakpoint</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">first_breakpoint</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] Hit the first breakpoint.</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] Hit user defined breakpoint.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 分离
</span>    <span class="k">def</span> <span class="nf">detach</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_DETACH</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">[*] Detached from process.</span><span class="sh">"</span><span class="p">)</span>

    <span class="c1"># 设置断点
</span>    <span class="k">def</span> <span class="nf">bp_set</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">breakpoints</span><span class="p">:</span>
            <span class="n">original_byte</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">read_process_memory</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="nf">write_process_memory</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\xCC</span><span class="sh">'</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">breakpoints</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_byte</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># 读内存
</span>    <span class="k">def</span> <span class="nf">read_process_memory</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">''</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_READ_D</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="nf">c_void_p</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="nf">bytes</span><span class="p">([</span><span class="n">value</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1"># 写内存
</span>    <span class="k">def</span> <span class="nf">write_process_memory</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">byte</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_WRITE_D</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="nf">c_void_p</span><span class="p">(</span><span class="n">address</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">byte</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c1"># 检查进程是否停止
</span>    <span class="k">def</span> <span class="nf">is_stopped</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="c1"># 获取停止信号
</span>    <span class="k">def</span> <span class="nf">get_stop_signal</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="nf">return </span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>

<span class="c1"># 示例使用
</span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">dbg</span> <span class="o">=</span> <span class="nf">debugger</span><span class="p">()</span>
    <span class="n">dbg</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">"</span><span class="s">/System/Applications/Calculator.app/Contents/MacOS/Calculator</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">dbg</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>``my_debugger_defines.py`</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*-
# @Date    : 2016-08-11 16:07:38
# @Author  : giantbranch (giantbranch@gmail.com)
# @Link    : http://blog.csdn.net/u012763794?viewmode=contents
</span>
<span class="c1"># 把所有的结构体，联合体，常量等放这，方便以后维护
</span>
<span class="kn">from</span> <span class="n">ctypes</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># 给ctypes类型重新命名，跟windows编程接轨吧
</span><span class="n">BYTE</span> <span class="o">=</span> <span class="n">c_ubyte</span>
<span class="n">WORD</span> <span class="o">=</span> <span class="n">c_ushort</span>
<span class="n">DWORD</span> <span class="o">=</span> <span class="n">c_ulong</span>
<span class="n">LPBYTE</span> <span class="o">=</span> <span class="nc">POINTER</span><span class="p">(</span><span class="n">c_ubyte</span><span class="p">)</span>
<span class="n">LPTSTR</span> <span class="o">=</span> <span class="nc">POINTER</span><span class="p">(</span><span class="n">c_char</span><span class="p">)</span>
<span class="n">HANDLE</span> <span class="o">=</span> <span class="n">c_void_p</span>
<span class="n">PVOID</span> <span class="o">=</span> <span class="n">c_void_p</span>
<span class="n">LPVOID</span> <span class="o">=</span> <span class="n">c_void_p</span>
<span class="n">UINT_PTR</span> <span class="o">=</span> <span class="n">c_ulong</span>
<span class="n">SIZE_T</span> <span class="o">=</span> <span class="n">c_ulong</span>

<span class="c1"># 常量
</span><span class="n">DEBUG_PROCESS</span> <span class="o">=</span> <span class="mh">0x00000001</span>
<span class="n">CREATE_NEW_CONSOLE</span> <span class="o">=</span> <span class="mh">0x00000010</span>
<span class="n">PROCESS_ALL_ACCESS</span> <span class="o">=</span> <span class="mh">0x001F0FFF</span>
<span class="n">INFINITE</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span>
<span class="n">DBG_CONTINUE</span> <span class="o">=</span> <span class="mh">0x00010002</span>

<span class="c1"># 调试事件常量
</span><span class="n">EXCEPTION_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x1</span>
<span class="n">CREATE_THREAD_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x2</span>
<span class="n">CREATE_PROCESS_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x3</span>
<span class="n">EXIT_THREAD_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x4</span>
<span class="n">EXIT_PROCESS_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x5</span>
<span class="n">LOAD_DLL_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x6</span>
<span class="n">UNLOAD_DLL_DEBUG_EVENT</span> <span class="o">=</span> <span class="mh">0x7</span>
<span class="n">OUTPUT_DEBUG_STRING_EVENT</span> <span class="o">=</span> <span class="mh">0x8</span>
<span class="n">RIP_EVENT</span> <span class="o">=</span> <span class="mh">0x9</span>

<span class="c1"># 调试异常代号
</span><span class="n">EXCEPTION_ACCESS_VIOLATION</span> <span class="o">=</span> <span class="mh">0xC0000005</span>
<span class="n">EXCEPTION_BREAKPOINT</span> <span class="o">=</span> <span class="mh">0x80000003</span>
<span class="n">EXCEPTION_GUARD_PAGE</span> <span class="o">=</span> <span class="mh">0x80000001</span>
<span class="n">EXCEPTION_SINGLE_STEP</span> <span class="o">=</span> <span class="mh">0x80000004</span>

<span class="c1"># Thread constants for CreateToolhelp32Snapshot()
</span><span class="n">TH32CS_SNAPHEAPLIST</span> <span class="o">=</span> <span class="mh">0x00000001</span>
<span class="n">TH32CS_SNAPPROCESS</span> <span class="o">=</span> <span class="mh">0x00000002</span>
<span class="n">TH32CS_SNAPTHREAD</span> <span class="o">=</span> <span class="mh">0x00000004</span>
<span class="n">TH32CS_SNAPMODULE</span> <span class="o">=</span> <span class="mh">0x00000008</span>
<span class="n">TH32CS_INHERIT</span> <span class="o">=</span> <span class="mh">0x80000000</span>
<span class="n">TH32CS_SNAPALL</span> <span class="o">=</span> <span class="p">(</span><span class="n">TH32CS_SNAPHEAPLIST</span> <span class="o">|</span> <span class="n">TH32CS_SNAPPROCESS</span> <span class="o">|</span> <span class="n">TH32CS_SNAPTHREAD</span> <span class="o">|</span> <span class="n">TH32CS_SNAPMODULE</span><span class="p">)</span>
<span class="n">THREAD_ALL_ACCESS</span> <span class="o">=</span> <span class="mh">0x001F03FF</span>

<span class="c1"># Context flags for GetThreadContext()
</span><span class="n">CONTEXT_FULL</span> <span class="o">=</span> <span class="mh">0x00010007</span>
<span class="n">CONTEXT_DEBUG_REGISTERS</span> <span class="o">=</span> <span class="mh">0x00010010</span>

<span class="c1"># Memory permissions
</span><span class="n">PAGE_EXECUTE_READWRITE</span> <span class="o">=</span> <span class="mh">0x00000040</span>

<span class="c1"># Hardware breakpoint conditions
</span><span class="n">HW_ACCESS</span> <span class="o">=</span> <span class="mh">0x00000003</span>
<span class="n">HW_EXECUTE</span> <span class="o">=</span> <span class="mh">0x00000000</span>
<span class="n">HW_WRITE</span> <span class="o">=</span> <span class="mh">0x00000001</span>

<span class="c1"># Memory page permissions, used by VirtualProtect()
</span><span class="n">PAGE_NOACCESS</span> <span class="o">=</span> <span class="mh">0x00000001</span>
<span class="n">PAGE_READONLY</span> <span class="o">=</span> <span class="mh">0x00000002</span>
<span class="n">PAGE_READWRITE</span> <span class="o">=</span> <span class="mh">0x00000004</span>
<span class="n">PAGE_WRITECOPY</span> <span class="o">=</span> <span class="mh">0x00000008</span>
<span class="n">PAGE_EXECUTE</span> <span class="o">=</span> <span class="mh">0x00000010</span>
<span class="n">PAGE_EXECUTE_READ</span> <span class="o">=</span> <span class="mh">0x00000020</span>
<span class="n">PAGE_EXECUTE_READWRITE</span> <span class="o">=</span> <span class="mh">0x00000040</span>
<span class="n">PAGE_EXECUTE_WRITECOPY</span> <span class="o">=</span> <span class="mh">0x00000080</span>
<span class="n">PAGE_GUARD</span> <span class="o">=</span> <span class="mh">0x00000100</span>
<span class="n">PAGE_NOCACHE</span> <span class="o">=</span> <span class="mh">0x00000200</span>
<span class="n">PAGE_WRITECOMBINE</span> <span class="o">=</span> <span class="mh">0x00000400</span>

<span class="c1"># CreateProcessA()函数的结构,(用于设置创建子进程的各种属性)
</span><span class="k">class</span> <span class="nc">STARTUPINFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">cb</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpReserved</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPTSTR</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpDesktop</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPTSTR</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpTitle</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPTSTR</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwX</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwY</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwXSize</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwYSize</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwXCountChars</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwYCountChars</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwFillAttribute</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">wShowWindow</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">cbReserved2</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpReserved2</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPTSTR</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">hStdInput</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">hStdOutput</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">hStdError</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># 进程的信息：进程线程的句柄，进程线程的id
</span><span class="k">class</span> <span class="nc">PROCESS_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">hProcess</span><span class="sh">"</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">hThread</span><span class="sh">"</span><span class="p">,</span> <span class="n">HANDLE</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwProcessId</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwThreadId</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># When the dwDebugEventCode is evaluated
</span><span class="k">class</span> <span class="nc">EXCEPTION_RECORD</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">EXCEPTION_RECORD</span><span class="p">.</span><span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionCode</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionRecord</span><span class="sh">"</span><span class="p">,</span> <span class="nc">POINTER</span><span class="p">(</span><span class="n">EXCEPTION_RECORD</span><span class="p">)),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionAddress</span><span class="sh">"</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">NumberParameters</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionInformation</span><span class="sh">"</span><span class="p">,</span> <span class="n">UINT_PTR</span> <span class="o">*</span> <span class="mi">15</span><span class="p">),</span>
<span class="p">]</span>

<span class="k">class</span> <span class="nc">_EXCEPTION_RECORD</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionCode</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionRecord</span><span class="sh">"</span><span class="p">,</span> <span class="nc">POINTER</span><span class="p">(</span><span class="n">EXCEPTION_RECORD</span><span class="p">)),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionAddress</span><span class="sh">"</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">NumberParameters</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionInformation</span><span class="sh">"</span><span class="p">,</span> <span class="n">UINT_PTR</span> <span class="o">*</span> <span class="mi">15</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># Exceptions
</span><span class="k">class</span> <span class="nc">EXCEPTION_DEBUG_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExceptionRecord</span><span class="sh">"</span><span class="p">,</span> <span class="n">EXCEPTION_RECORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwFirstChance</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># it populates this union appropriately
</span><span class="k">class</span> <span class="nc">DEBUG_EVENT_UNION</span><span class="p">(</span><span class="n">Union</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Exception</span><span class="sh">"</span><span class="p">,</span> <span class="n">EXCEPTION_DEBUG_INFO</span><span class="p">),</span>
        <span class="c1">#        ("CreateThread",      CREATE_THREAD_DEBUG_INFO),
</span>        <span class="c1">#        ("CreateProcessInfo", CREATE_PROCESS_DEBUG_INFO),
</span>        <span class="c1">#        ("ExitThread",        EXIT_THREAD_DEBUG_INFO),
</span>        <span class="c1">#        ("ExitProcess",       EXIT_PROCESS_DEBUG_INFO),
</span>        <span class="c1">#        ("LoadDll",           LOAD_DLL_DEBUG_INFO),
</span>        <span class="c1">#        ("UnloadDll",         UNLOAD_DLL_DEBUG_INFO),
</span>        <span class="c1">#        ("DebugString",       OUTPUT_DEBUG_STRING_INFO),
</span>        <span class="c1">#        ("RipInfo",           RIP_INFO),
</span>    <span class="p">]</span>

<span class="c1"># DEBUG_EVENT describes a debugging event
# that the debugger has trapped
</span><span class="k">class</span> <span class="nc">DEBUG_EVENT</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwDebugEventCode</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwProcessId</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwThreadId</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">u</span><span class="sh">"</span><span class="p">,</span> <span class="n">DEBUG_EVENT_UNION</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># Used by the CONTEXT structure
</span><span class="k">class</span> <span class="nc">FLOATING_SAVE_AREA</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>

        <span class="p">(</span><span class="sh">"</span><span class="s">ControlWord</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">StatusWord</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">TagWord</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ErrorOffset</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ErrorSelector</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">DataOffset</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">DataSelector</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">RegisterArea</span><span class="sh">"</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span> <span class="mi">80</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Cr0NpxState</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># The CONTEXT structure which holds all of the
# register values after a GetThreadContext() call
</span><span class="k">class</span> <span class="nc">CONTEXT</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>

        <span class="p">(</span><span class="sh">"</span><span class="s">ContextFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr0</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr1</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr2</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr3</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr6</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Dr7</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">FloatSave</span><span class="sh">"</span><span class="p">,</span> <span class="n">FLOATING_SAVE_AREA</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegGs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegFs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegEs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegDs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Edi</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Esi</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Ebx</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Edx</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Ecx</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Eax</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Ebp</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Eip</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegCs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">EFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Esp</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">SegSs</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">ExtendedRegisters</span><span class="sh">"</span><span class="p">,</span> <span class="n">BYTE</span> <span class="o">*</span> <span class="mi">512</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># THREADENTRY32 contains information about a thread
# we use this for enumerating all of the system threads
</span>
<span class="k">class</span> <span class="nc">THREADENTRY32</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwSize</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">cntUsage</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">th32ThreadID</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">th32OwnerProcessID</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">tpBasePri</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">tpDeltaPri</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwFlags</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># Supporting struct for the SYSTEM_INFO_UNION union
</span><span class="k">class</span> <span class="nc">PROC_STRUCT</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">wProcessorArchitecture</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">wReserved</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># Supporting union for the SYSTEM_INFO struct
</span><span class="k">class</span> <span class="nc">SYSTEM_INFO_UNION</span><span class="p">(</span><span class="n">Union</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwOemId</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">sProcStruc</span><span class="sh">"</span><span class="p">,</span> <span class="n">PROC_STRUCT</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># SYSTEM_INFO structure is populated when a call to
# kernel32.GetSystemInfo() is made. We use the dwPageSize
# member for size calculations when setting memory breakpoints
</span><span class="k">class</span> <span class="nc">SYSTEM_INFO</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">uSysInfo</span><span class="sh">"</span><span class="p">,</span> <span class="n">SYSTEM_INFO_UNION</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwPageSize</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpMinimumApplicationAddress</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">lpMaximumApplicationAddress</span><span class="sh">"</span><span class="p">,</span> <span class="n">LPVOID</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwActiveProcessorMask</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwNumberOfProcessors</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwProcessorType</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">dwAllocationGranularity</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">wProcessorLevel</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">wProcessorRevision</span><span class="sh">"</span><span class="p">,</span> <span class="n">WORD</span><span class="p">),</span>
    <span class="p">]</span>

<span class="c1"># MEMORY_BASIC_INFORMATION contains information about a
# particular region of memory. A call to kernel32.VirtualQuery()
# populates this structure.
</span><span class="k">class</span> <span class="nc">MEMORY_BASIC_INFORMATION</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">BaseAddress</span><span class="sh">"</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">AllocationBase</span><span class="sh">"</span><span class="p">,</span> <span class="n">PVOID</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">AllocationProtect</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">RegionSize</span><span class="sh">"</span><span class="p">,</span> <span class="n">SIZE_T</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">State</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Protect</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
        <span class="p">(</span><span class="sh">"</span><span class="s">Type</span><span class="sh">"</span><span class="p">,</span> <span class="n">DWORD</span><span class="p">),</span>
    <span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">my_test.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*-
# @Date    : 2016-08-12 14:18:10
# @Author  : giantbranch (giantbranch@gmail.com)
# @Link    : http://blog.csdn.net/u012763794?viewmode=contents
</span>
<span class="c1"># use: python my_test.py
</span><span class="kn">import</span> <span class="n">my_debugger</span>
<span class="kn">from</span> <span class="n">my_debugger_defines</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">debugger</span> <span class="o">=</span> <span class="n">my_debugger</span><span class="p">.</span><span class="nf">debugger</span><span class="p">()</span>
<span class="n">debugger</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">"</span><span class="s">/System/Applications/Calculator.app/Contents/MacOS/Calculator</span><span class="sh">"</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>注：</p>

  <p>1.在macOS上，调试器和系统调用的API与Windows有所不同。macOS使用POSIX标准和Mach内核提供的API。由于macOS没有直接等同于Windows的调试API，将使用<code class="language-plaintext highlighter-rouge">ptrace</code>和<code class="language-plaintext highlighter-rouge">sysctl</code>等POSIX和Mach内核API来实现类似的功能。</p>

  <p>2.</p>

  <ol>
    <li><strong>加载和附加进程</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">load</code>方法使用<code class="language-plaintext highlighter-rouge">os.fork</code>和<code class="language-plaintext highlighter-rouge">os.execv</code>来启动新进程，并使用<code class="language-plaintext highlighter-rouge">ptrace</code>来调试子进程。</li>
        </ul>
      </blockquote>
      <ul>
        <li><code class="language-plaintext highlighter-rouge">attach</code>方法使用<code class="language-plaintext highlighter-rouge">ptrace</code>来附加到现有进程。</li>
      </ul>
    </li>
    <li><strong>调试事件处理</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">get_debug_event</code>方法使用<code class="language-plaintext highlighter-rouge">waitpid</code>来等待子进程的状态变化，并根据信号类型处理调试事件。</li>
        </ul>
      </blockquote>
      <ul>
        <li><code class="language-plaintext highlighter-rouge">handle_breakpoint</code>方法处理断点事件。</li>
      </ul>
    </li>
    <li><strong>内存操作</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">read_process_memory</code>和<code class="language-plaintext highlighter-rouge">write_process_memory</code>方法使用<code class="language-plaintext highlighter-rouge">ptrace</code>来读写目标进程的内存。</li>
        </ul>
      </blockquote>
    </li>
    <li><strong>断点设置</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">bp_set</code>方法在指定地址设置断点，并将原始字节保存以便恢复。</li>
        </ul>
      </blockquote>
    </li>
  </ol>

  <p>3.在macOS上，<code class="language-plaintext highlighter-rouge">ptrace</code>函数的调用方式与Linux有所不同。macOS的<code class="language-plaintext highlighter-rouge">ptrace</code>函数需要通过<code class="language-plaintext highlighter-rouge">libc</code>库来调用，并且需要使用正确的常量。<code class="language-plaintext highlighter-rouge">PT_TRACE_ME</code>是Linux上的常量，在macOS上应该使用<code class="language-plaintext highlighter-rouge">PT_ATTACH</code>等常量。</p>

  <p>除此之外还需修改：</p>

  <ol>
    <li><strong>定义常量</strong>：在macOS上，<code class="language-plaintext highlighter-rouge">ptrace</code>的常量与Linux不同。我们定义了<code class="language-plaintext highlighter-rouge">PT_TRACE_ME</code>、<code class="language-plaintext highlighter-rouge">PT_ATTACH</code>、<code class="language-plaintext highlighter-rouge">PT_CONTINUE</code>、<code class="language-plaintext highlighter-rouge">PT_READ_D</code>、<code class="language-plaintext highlighter-rouge">PT_WRITE_D</code>和<code class="language-plaintext highlighter-rouge">PT_DETACH</code>等常量。</li>
    <li><strong>加载和附加进程</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">load</code>方法使用<code class="language-plaintext highlighter-rouge">os.fork</code>和<code class="language-plaintext highlighter-rouge">os.execv</code>来启动新进程，并使用<code class="language-plaintext highlighter-rouge">ptrace</code>来调试子进程。</li>
        </ul>
      </blockquote>
      <ul>
        <li><code class="language-plaintext highlighter-rouge">attach</code>方法使用<code class="language-plaintext highlighter-rouge">ptrace</code>来附加到现有进程。</li>
      </ul>
    </li>
    <li><strong>调试事件处理</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">get_debug_event</code>方法使用<code class="language-plaintext highlighter-rouge">waitpid</code>来等待子进程的状态变化，并根据信号类型处理调试事件。</li>
        </ul>
      </blockquote>
      <ul>
        <li><code class="language-plaintext highlighter-rouge">handle_breakpoint</code>方法处理断点事件。</li>
      </ul>
    </li>
    <li><strong>内存操作</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">read_process_memory</code>和<code class="language-plaintext highlighter-rouge">write_process_memory</code>方法使用<code class="language-plaintext highlighter-rouge">ptrace</code>来读写目标进程的内存。</li>
        </ul>
      </blockquote>
    </li>
    <li><strong>断点设置</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">bp_set</code>方法在指定地址设置断点，并将原始字节保存以便恢复。</li>
        </ul>
      </blockquote>
    </li>
    <li><strong>检查进程是否停止</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">is_stopped</code>方法检查进程是否停止。</li>
        </ul>
      </blockquote>
    </li>
    <li><strong>获取停止信号</strong>：
      <blockquote>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">get_stop_signal</code>方法获取停止信号。</li>
        </ul>
      </blockquote>
    </li>
  </ol>

  <p>4.<code class="language-plaintext highlighter-rouge">/System/Applications/Calculator.app</code>不是可执行的，应该改成<code class="language-plaintext highlighter-rouge">/System/Applications/Calculator.app/Contents/MacOS/Calculator</code></p>
</blockquote>

<p>运行结果：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20240924100730774.png" alt="image-20240924100730774" style="zoom:50%;" /></p>

<p>而且每次运行，<code class="language-plaintext highlighter-rouge">PID</code>号不同。</p>

<h2 id="3获取句柄">3.获取“句柄”</h2>

<blockquote>
  <p>OS学的不精，补充一下句柄：</p>

  <p>在计算机编程中，“句柄”是一个抽象引用，通常用于表示系统资源，比如文件、窗口或进程。在操作系统中，获取一个句柄允许程序访问和操作这些资源。</p>

  <p>获取句柄的具体意义：</p>

  <ol>
    <li><strong>句柄的作用</strong>：句柄使得程序可以通过一个简化的标识符与资源进行交互，而不需要直接处理资源的底层细节。</li>
    <li><strong>资源管理</strong>：操作系统使用句柄来跟踪和管理资源，以确保它们在使用时不会被意外释放或修改。</li>
  </ol>

  <ul>
    <li>假设在开发一个Windows应用程序，想要监控一个特定的进程（比如一个游戏）。你可以使用<code class="language-plaintext highlighter-rouge">kernel32.dll</code>中的<code class="language-plaintext highlighter-rouge">OpenProcess</code>函数来获取该进程的句柄。
      <blockquote>

        <ul>
          <li>OpenProcess的函数原型如下：若这个函数成功就会返回一个指向目标进程对象的句柄。</li>
        </ul>
      </blockquote>

      <ul>
        <li>
          <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="nf">OpenProcess</span><span class="p">(</span>
  <span class="n">DWORD</span> <span class="n">dwDesiredAccess</span><span class="p">,</span>
  <span class="n">BOOL</span> <span class="n">bInheritHandle</span><span class="p">,</span>
  <span class="n">DWORD</span> <span class="n">dwProcessId</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div>          </div>
        </li>
        <li>参数说明：
          <blockquote>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>- **dwDesiredAccess**：请求的访问权限，例如`PROCESS_ALL_ACCESS`表示请求所有权限。在这本书中，这个参数作者设为`PROCESS_ALL_ACCESS`,是为了满足调试的需求。
</pre></td></tr></tbody></table></code></pre></div>            </div>
          </blockquote>
          <ul>
            <li><strong>bInheritHandle</strong>：指定是否允许子进程继承该句柄。书中设置为<code class="language-plaintext highlighter-rouge">false</code>。</li>
            <li><strong>dwProcessId</strong>：目标进程的ID。</li>
          </ul>
        </li>
      </ul>
    </li>
    <li>
      <p>可以使用<code class="language-plaintext highlighter-rouge">libproc</code>库来获取进程信息，<code class="language-plaintext highlighter-rouge">libproc</code>提供了一些与进程相关的功能。要实现类似于<code class="language-plaintext highlighter-rouge">OpenProcess</code>的功能，通常你会用到<code class="language-plaintext highlighter-rouge">proc_pidinfo</code>函数来获取进程信息。</p>
    </li>
    <li><strong>特别注意：macOS或者Linux 无法获取进程的句柄！！！</strong>原因：macOS和Linux的进程管理与Windows有所不同。它们不使用“句柄”的概念，而是通过进程ID（PID）来标识和操作进程。
      <blockquote>

        <ul>
          <li>主要区别：
    &gt;     - <strong>Windows</strong>：使用句柄（如<code class="language-plaintext highlighter-rouge">OpenProcess</code>）来引用和管理进程，句柄可以直接用于系统调用。</li>
        </ul>
      </blockquote>
      <ul>
        <li><strong>macOS/Linux</strong>：通过进程ID进行管理，通常使用<code class="language-plaintext highlighter-rouge">proc_pidinfo</code>、<code class="language-plaintext highlighter-rouge">ptrace</code>等系统调用来与进程交互。</li>
      </ul>
    </li>
  </ul>
</blockquote>

<p>类似于<code class="language-plaintext highlighter-rouge">kernel32.dll</code>的<code class="language-plaintext highlighter-rouge">OpenProcess</code>，<code class="language-plaintext highlighter-rouge">libc</code>的<code class="language-plaintext highlighter-rouge">proc_pidinfo</code>用于获取进程信息。</p>

<p>Debugger中定义的：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>    <span class="c1"># Mac:获取进程的句柄，要调试当然要全不权限了
</span>    <span class="k">def</span> <span class="nf">open_process</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">c_void_p</span><span class="p">:</span>
        <span class="sh">"""</span><span class="s">获取进程的伪句柄.</span><span class="sh">"""</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nc">ProcBSDInfo</span><span class="p">()</span>

        <span class="c1"># 调用proc_pidinfo
</span>        <span class="n">ret</span> <span class="o">=</span> <span class="n">libc</span><span class="p">.</span><span class="nf">proc_pidinfo</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">byref</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">成功获取进程信息: 进程ID: </span><span class="si">{</span><span class="n">info</span><span class="p">.</span><span class="n">pbi_pid</span><span class="si">}</span><span class="s">, 进程名: </span><span class="si">{</span><span class="n">info</span><span class="p">.</span><span class="n">pbi_comm</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="sh">'</span><span class="s">utf-8</span><span class="sh">'</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">self</span><span class="p">.</span><span class="n">h_process</span> <span class="o">=</span> <span class="nf">c_void_p</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>  <span class="c1"># 这里返回进程ID作为伪句柄
</span>            <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">h_process</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">无法获取进程 </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s"> 的信息。</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>需要先定义类<code class="language-plaintext highlighter-rouge">ProcBSDInfo</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># 定义PROC_PIDTASKINFO结构，用于open_process函数
</span><span class="k">class</span> <span class="nc">ProcBSDInfo</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="sh">'</span><span class="s">pbi_pid</span><span class="sh">'</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>           <span class="c1"># 进程ID
</span>        <span class="p">(</span><span class="sh">'</span><span class="s">pbi_comm</span><span class="sh">'</span><span class="p">,</span> <span class="n">c_char</span> <span class="o">*</span> <span class="mi">256</span><span class="p">),</span>  <span class="c1"># 进程名称
</span>        <span class="c1"># 可以根据需要添加更多字段
</span>    <span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>注：在macOS中，获取“句柄”的概念与Windows不同。虽然你可以使用<code class="language-plaintext highlighter-rouge">proc_pidinfo</code>获取进程信息，但并没有直接的“句柄”概念。</p>

  <p>在上面的示例中，<code class="language-plaintext highlighter-rouge">open_process</code>方法返回的是一个与进程ID相关的<code class="language-plaintext highlighter-rouge">c_void_p</code>类型，这可以视为一个“句柄”。然而，它并不是像Windows中的句柄那样能够直接用于进程管理。</p>

  <p>如果你需要对进程进行进一步的操作，如读写内存或调试，macOS通常使用<code class="language-plaintext highlighter-rouge">ptrace</code>等系统调用，这些调用允许你控制和监视其他进程。</p>

  <p>【模拟句柄的示例】</p>

  <p>在示例代码中，<code class="language-plaintext highlighter-rouge">self.h_process = c_void_p(pid)</code>相当于返回了一个代表进程的“句柄”，但请记住：</p>

  <ul>
    <li><strong>并不是一个真正的句柄</strong>：它只是一个指向进程ID的指针，并不能直接用于系统调用。</li>
    <li><strong>后续操作</strong>：如果需要执行更复杂的操作，可能需要使用其他系统调用（如<code class="language-plaintext highlighter-rouge">ptrace</code>）来实现具体功能。</li>
  </ul>
</blockquote>

<h2 id="4进程的附加">4.进程的附加</h2>

<p><code class="language-plaintext highlighter-rouge">DebugActiveProcess</code>是Windows API中的一个函数，用于将调试器附加到一个正在运行的进程上。这个函数允许调试器开始调试一个已经存在的进程，而不是创建一个新的进程。</p>

<p>函数原型如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">DebugActiveProcess</span><span class="p">(</span>
  <span class="n">DWORD</span> <span class="n">dwProcessId</span>  <span class="c1">// 要附加的进程的ID</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>在macOS上，类似于<code class="language-plaintext highlighter-rouge">DebugActiveProcess</code>的操作可以通过<code class="language-plaintext highlighter-rouge">ptrace</code>函数实现。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">PT_ATTACH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">def</span> <span class="nf">attach</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="n">self</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
    <span class="n">libc</span><span class="p">.</span><span class="nf">ptrace</span><span class="p">(</span><span class="n">PT_ATTACH</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">debugger_active</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] Attached to process with PID: </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p>其中，<code class="language-plaintext highlighter-rouge">ptrace</code>的函数原型是:</p>

  <p><code class="language-plaintext highlighter-rouge">long ptrace(int request, pid_t pid, void *addr, void *data);</code></p>

  <ul>
    <li><strong><code class="language-plaintext highlighter-rouge">PT_ATTACH = 10</code></strong>：这是一个常量，用于表示<code class="language-plaintext highlighter-rouge">ptrace</code>系统调用中的<code class="language-plaintext highlighter-rouge">PT_ATTACH</code>命令。该命令用于附加到指定的进程，允许调用进程控制和监视被附加的进程。
      <blockquote>

        <ul>
          <li>注意：<code class="language-plaintext highlighter-rouge">my_debuggers.py</code>中一开始有<code class="language-plaintext highlighter-rouge">ptrace</code>的常量</li>
        </ul>
      </blockquote>

      <ul>
        <li>
          <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c1"># Define ptrace constants for macOS
</span><span class="n">PT_TRACE_ME</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">PT_ATTACH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">PT_CONTINUE</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">PT_READ_D</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">PT_WRITE_D</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">PT_DETACH</span> <span class="o">=</span> <span class="mi">11</span>
</pre></td></tr></tbody></table></code></pre></div>          </div>
        </li>
        <li><strong><code class="language-plaintext highlighter-rouge">PT_TRACE_ME = 0</code></strong>
          <blockquote>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>- 这个常量用于让当前进程告诉内核自己要被调试。调用这个命令后，内核会允许调试器对这个进程进行监控。

**`PT_ATTACH = 10`**

- 该命令用于将调试器附加到一个已经运行的进程。使用这个命令后，调试器可以控制被附加的进程，并获取其状态信息。

**`PT_CONTINUE = 7`**

- 这个常量用于继续一个被调试的进程的执行。在调试过程中，进程可能会因为某些事件（如断点）被暂停，使用这个命令可以使其恢复运行。

**`PT_READ_D = 2`**

- 这个命令用于从被调试进程的地址空间中读取数据。调用这个命令后，可以获取指定地址的数据。

**`PT_WRITE_D = 3`**

- 这个常量用于向被调试进程的地址空间写入数据。使用此命令后，可以修改被调试进程内存中指定地址的内容。

**`PT_DETACH = 11`**

- 这个命令用于从被调试进程中分离调试器。使用后，进程将继续正常运行，而调试器不再控制它。
</pre></td></tr></tbody></table></code></pre></div>            </div>
          </blockquote>
        </li>
      </ul>
    </li>
    <li>
      <p><code class="language-plaintext highlighter-rouge">pid</code>: 被附加进程的进程ID。这个进程将被调试。</p>
    </li>
    <li><code class="language-plaintext highlighter-rouge">None, None</code>: 这些参数在附加时通常不需要使用，可以用<code class="language-plaintext highlighter-rouge">None</code>来表示。</li>
  </ul>
</blockquote>

<p><strong><code class="language-plaintext highlighter-rouge">self.debugger_active = True</code></strong>: 将类的实例变量<code class="language-plaintext highlighter-rouge">self.debugger_active</code>设置为<code class="language-plaintext highlighter-rouge">True</code>，表示调试器现在处于活动状态，已成功附加到进程。</p>

<h2 id="5等待和处理调试事件">5.等待和处理调试事件</h2>

<p><code class="language-plaintext highlighter-rouge">WaitForDebugEvent</code> 是 Windows API 中用于调试的函数，它会在调试事件发生时阻塞当前线程，并返回相关的调试事件信息</p>

<p>下面是<code class="language-plaintext highlighter-rouge">WaitForDebugEvent</code>的函数原型：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">WaitForDebugEvent</span><span class="p">(</span>
  <span class="n">LPDEBUG_EVENT</span> <span class="n">lpDebugEvent</span><span class="p">,</span><span class="c1">//指向 DEBUG_EVENT 结构体的指针，用于接收调试事件信息</span>
  <span class="n">DWORD</span>         <span class="n">dwMilliseconds</span> <span class="c1">// 等待的超时时间，单位为毫秒</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">libc</code>中是<code class="language-plaintext highlighter-rouge">libc.waitpid(self.pid, byref(status), 0)</code>函数有类似的功能。函数原型如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span>
<span class="n">pid_t</span> <span class="nf">waitpid</span><span class="p">(</span><span class="n">pid_t</span> <span class="n">pid</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="kt">int</span> <span class="n">options</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>执行的结果会存储在<code class="language-plaintext highlighter-rouge">status</code>中。</p>

<p>完整代码：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="cp"># 获取调试事件
</span><span class="n">def</span> <span class="n">get_debug_event</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
    <span class="cp">#  创建一个c_int类型的变量status，用于存储waitpid函数返回的进程状态信息
</span>    <span class="n">status</span> <span class="o">=</span> <span class="n">c_int</span><span class="p">()</span>
    <span class="cp"># 调用waitpid函数，等待指定进程（通过self.pid）的状态变化，并将结果存储在status中。参数0表示阻塞，直到有状态变化发生。
</span>    <span class="n">libc</span><span class="p">.</span><span class="n">waitpid</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">byref</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="cp"># 检查进程是否因信号停止
</span>    <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">is_stopped</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="o">:</span>
        <span class="n">signal_number</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">get_stop_signal</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">signal_number</span> <span class="o">==</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGTRAP</span><span class="o">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">handle_breakpoint</span><span class="p">()</span>
        <span class="n">elif</span> <span class="n">signal_number</span> <span class="o">==</span> <span class="n">signal</span><span class="p">.</span><span class="n">SIGSEGV</span><span class="o">:</span>
            <span class="n">print</span><span class="p">(</span><span class="s">"Access Violation Detected."</span><span class="p">)</span>
        <span class="k">else</span><span class="o">:</span>
            <span class="n">print</span><span class="p">(</span><span class="n">f</span><span class="s">"Received signal: {signal_number}"</span><span class="p">)</span>
        <span class="n">libc</span><span class="p">.</span><span class="n">ptrace</span><span class="p">(</span><span class="n">PT_CONTINUE</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span> <span class="n">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="6恢复">6.恢复</h2>

<p><code class="language-plaintext highlighter-rouge">kernel32.ContinueDebugEvent</code> 是 Windows API 中的一个函数，用于在调试器接收到调试事件后，指示操作系统继续执行被调试的进程或线程。这个函数通常在调试器处理完调试事件（如断点、异常等）后调用，以便让被调试的进程或线程继续执行。</p>

<p>函数原型：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">ContinueDebugEvent</span><span class="p">(</span>
  <span class="n">DWORD</span> <span class="n">dwProcessId</span><span class="p">,</span>
  <span class="n">DWORD</span> <span class="n">dwThreadId</span><span class="p">,</span>
  <span class="n">DWORD</span> <span class="n">dwContinueStatus</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ol>
  <li><strong>dwProcessId</strong>
    <ul>
      <li><strong>类型</strong>: <code class="language-plaintext highlighter-rouge">DWORD</code></li>
      <li><strong>描述</strong>: 被调试进程的进程 ID。这个 ID 通常是从调试事件结构体（如 <code class="language-plaintext highlighter-rouge">DEBUG_EVENT</code>）中获取的。</li>
    </ul>
  </li>
  <li><strong>dwThreadId</strong>
    <ul>
      <li><strong>类型</strong>: <code class="language-plaintext highlighter-rouge">DWORD</code></li>
      <li><strong>描述</strong>: 被调试线程的线程 ID。这个 ID 通常也是从调试事件结构体（如 <code class="language-plaintext highlighter-rouge">DEBUG_EVENT</code>）中获取的。</li>
    </ul>
  </li>
  <li><strong>dwContinueStatus</strong>
    <ul>
      <li><strong>类型</strong>: <code class="language-plaintext highlighter-rouge">DWORD</code></li>
      <li><strong>描述</strong>: 指示操作系统如何继续执行被调试的线程。这个参数可以是以下两个值之一：
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DBG_CONTINUE</code>: 指示操作系统继续执行线程，并忽略异常（通常用于处理已处理的异常）。</li>
          <li><code class="language-plaintext highlighter-rouge">DBG_EXCEPTION_NOT_HANDLED</code>: 指示操作系统继续执行线程，但将异常传递给线程的默认异常处理程序（通常用于未处理的异常）。</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<p><code class="language-plaintext highlighter-rouge">libc.ptrace(PT_CONTINUE, self.pid, None, 0)</code>可以实现类似的功能</p>

<h2 id="7分离调试器和被调试程序">7.分离调试器和被调试程序</h2>

<p>这是附加进程之后需要进行的。</p>

<p><code class="language-plaintext highlighter-rouge">winAPI</code>是<code class="language-plaintext highlighter-rouge">kernel32.DebugActiveProcessStop</code>,函数原型如下：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">BOOL</span> <span class="nf">DebugActiveProcessStop</span><span class="p">(</span>
  <span class="n">DWORD</span> <span class="n">dwProcessId</span>
<span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>只需传入进程ID 即可。</p>

<p>同样在Mac中，用<code class="language-plaintext highlighter-rouge">libc.ptrace</code>实现:<code class="language-plaintext highlighter-rouge">libc.ptrace(PT_DETACH, self.pid, None, None)</code></p>

<h2 id="8测试">8.测试</h2>

<p>测试：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="c1"># -*- coding: utf-8 -*-
# @Date    : 2016-08-12 14:18:10
# @Author  : giantbranch (giantbranch@gmail.com)
# @Link    : http://blog.csdn.net/u012763794?viewmode=contents
</span>
<span class="c1"># use: python my_test.py
</span><span class="kn">import</span> <span class="n">my_debugger</span>
<span class="kn">from</span> <span class="n">my_debugger_defines</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">debugger</span> <span class="o">=</span> <span class="n">my_debugger</span><span class="p">.</span><span class="nf">debugger</span><span class="p">()</span>

<span class="c1"># macOS 上的计算器应用程序路径
</span><span class="n">calculator_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">/System/Applications/Calculator.app/Contents/MacOS/Calculator</span><span class="sh">"</span>

<span class="c1"># 加载计算器应用程序
</span><span class="n">debugger</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">calculator_path</span><span class="p">)</span>

<span class="c1"># 获取用户输入的 PID
</span><span class="n">pid</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Enter the PID of the process to attach to:</span><span class="sh">"</span><span class="p">)</span>
<span class="n">debugger</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>

<span class="n">debugger</span><span class="p">.</span><span class="nf">detach</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>从活动监视器可以得到<code class="language-plaintext highlighter-rouge">Calculator</code>的PID是5167</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20240926111454500.png" alt="image-20240926111454500" style="zoom:50%;" /></p>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2024/05/26/burpsuite/" data-toggle="tooltip" data-placement="top" title="Burpsuite">
                        Previous<br>
                        <span>Burpsuite</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2024/09/15/go/" data-toggle="tooltip" data-placement="top" title="go基础">
                        Next<br>
                        <span>go基础</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0089" 
                    href="/archive/?tag=%E4%B9%A6%E7%B1%8D%E9%98%85%E8%AF%BB"
                    title="书籍阅读"
                    rel="3">书籍阅读</a>
        
                <a data-sort="0068" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="24">算法</a>
        
                <a data-sort="0074" 
                    href="/archive/?tag=%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BDAI%E5%9F%BA%E7%A1%80"
                    title="人工智能AI基础"
                    rel="18">人工智能AI基础</a>
        
                <a data-sort="0080" 
                    href="/archive/?tag=%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%90%B4%E6%81%A9%E8%BE%BE"
                    title="机器学习-吴恩达"
                    rel="12">机器学习-吴恩达</a>
        
                <a data-sort="0082" 
                    href="/archive/?tag=%E5%8A%9B%E6%89%A3"
                    title="力扣"
                    rel="10">力扣</a>
        
                <a data-sort="0087" 
                    href="/archive/?tag=python%E5%9F%BA%E7%A1%80"
                    title="python基础"
                    rel="5">python基础</a>
        
                <a data-sort="0089" 
                    href="/archive/?tag=spring6"
                    title="spring6"
                    rel="3">spring6</a>
        
                <a data-sort="0090" 
                    href="/archive/?tag=Java%E5%9F%BA%E7%A1%80"
                    title="Java基础"
                    rel="2">Java基础</a>
        
                <a data-sort="0090" 
                    href="/archive/?tag=numpy"
                    title="numpy"
                    rel="2">numpy</a>
        
                <a data-sort="0090" 
                    href="/archive/?tag=ollama%E5%B7%A5%E5%85%B7"
                    title="ollama工具"
                    rel="2">ollama工具</a>
        
                <a data-sort="0090" 
                    href="/archive/?tag=pandas"
                    title="pandas"
                    rel="2">pandas</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://m.freebuf.com/">freebuf</a></li>
  
  <li><a href="https://xz.aliyun.com/">先知</a></li>
  
  <li><a href="https://www.sec-in.com/All">sec-in</a></li>
  
  <li><a href="https://paper.seebug.org/">see-bug</a></li>
  
  <li><a href="https://twitter.com/Concurr21486093">我的推特</a></li>
  
  <li><a href="https://pdai.tech/">pdai</a></li>
  
  <li><a href="https://nodejs.org/dist/">nodejs index of dist</a></li>
  
  <li><a href="#">公众号：小东方不败</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/Concurr21486093">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/Hilda">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/kirsten-1">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Hilda 2025
                    <br>
                    Powered by <a href="https://kirsten-1.github.io/">hilda Blog</a>
<!--                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"-->
<!--                        height="20px"-->
<!--                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">-->
<!--                    </iframe>-->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
