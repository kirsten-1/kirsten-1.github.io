<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 Hilda 的个人博客，与你一起发现更大的世界 | 要做一个有 swag 的程序员">
    <meta name="keywords" content="Hilda">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="手写Spring_篇章1 - Hilda的博客 | Your genius girlfriend's blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="手写Spring01_之如何扫描+获取Bean(原型还是单例)
">
    
    <meta property="article:published_time" content=" 2024-04-15T00:00:00Z">
    
    
    <meta property="article:author" content="Hilda">
    
    
    <meta property="article:tag" content="手写Spring">
    
    
    <meta property="og:image" content="https://kirsten-1.github.io">
    <meta property="og:url" content="https://kirsten-1.github.io/2024/04/15/spring_%E7%AF%87%E7%AB%A01/">
    <meta property="og:site_name" content="Hilda的博客 | Your genius girlfriend's blog">

    <title>手写Spring_篇章1 - Hilda的博客 | Your genius girlfriend's blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://kirsten-1.github.io/2024/04/15/spring_%E7%AF%87%E7%AB%A01/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Hilda</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>




<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E6%89%8B%E5%86%99Spring" title="手写Spring">手写Spring</a>
                        
                    </div>
                    <h1>手写Spring_篇章1</h1>
                    
                    <h2 class="subheading">如何扫描+获取Bean(原型还是单例)</h2>
                    <span class="meta">Posted by Hilda on April 15, 2024</span>
                </div>
            </div>
        </div>
    </div>
</header>







<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="手写spring01_之如何扫描获取bean原型还是单例">手写Spring01_之如何扫描+获取Bean(原型还是单例)</h1>

<h2 id="0x01_说明">0x01_说明</h2>

<p>暂时不涉及懒加载，暂时用扫描配置的方式进行容器的创建。</p>

<h2 id="0x02_核心注解">0x02_核心注解</h2>

<h3 id="mycomponent">MyComponent</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myspring.annotation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span> <span class="c1">// 只写在类上面</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">MyComponent</span> <span class="o">{</span>
    <span class="c1">// bean的name</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="mycomponentscan">MyComponentScan</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myspring.annotation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span> <span class="c1">// 只写在类上面</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">MyComponentScan</span> <span class="o">{</span>
    <span class="c1">// 扫描的路径</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">()</span> <span class="k">default</span> <span class="s">""</span><span class="o">;</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="myscope">MyScope</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myspring.annotation</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>

<span class="cm">/**
 * bean是单例的还是prototype
 */</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">(</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span> <span class="c1">// 只写在类上面</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">MyScope</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">value</span><span class="o">();</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="0x03_beandefinition">0x03_BeanDefinition</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myspring.core</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyBeanDefinition</span> <span class="o">{</span>
    <span class="c1">//bean的类型</span>
    <span class="kd">private</span> <span class="nc">Class</span> <span class="n">clazz</span><span class="o">;</span>
    <span class="c1">//bean的作用域，是单例的还是原型</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">scope</span><span class="o">;</span>


    <span class="kd">public</span> <span class="nc">Class</span> <span class="nf">getClazz</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">clazz</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClazz</span><span class="o">(</span><span class="nc">Class</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">clazz</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getScope</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">scope</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setScope</span><span class="o">(</span><span class="nc">String</span> <span class="n">scope</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">scope</span> <span class="o">=</span> <span class="n">scope</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="0x04_容器">0x04_容器</h2>

<p><code class="language-plaintext highlighter-rouge">MyApplicationContext</code></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.myspring</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.myspring.annotation.MyComponent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.myspring.annotation.MyComponentScan</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.myspring.annotation.MyScope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.myspring.core.MyBeanDefinition</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>

<span class="cm">/**
 * 容器类
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyApplicationContext</span> <span class="o">{</span>
    <span class="c1">// 配置类</span>
    <span class="kd">private</span> <span class="nc">Class</span> <span class="n">configClass</span><span class="o">;</span>
    <span class="c1">// 单例池,存储单例对象</span>
    <span class="kd">private</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">singletonObjects</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
    <span class="c1">// beanDefinition的Map</span>
    <span class="kd">private</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">MyBeanDefinition</span><span class="o">&gt;</span> <span class="n">beanDefinitionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">MyApplicationContext</span><span class="o">(</span><span class="nc">Class</span> <span class="n">configClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">configClass</span> <span class="o">=</span> <span class="n">configClass</span><span class="o">;</span>

        <span class="c1">//解析配置类</span>

        <span class="cm">/**
         * 解析注解@MyComponentScan   扫描什么路径---&gt;开始扫描
         */</span>
        <span class="c1">//获取配置类上面的MyComponentScan注解</span>

        <span class="n">scan</span><span class="o">(</span><span class="n">configClass</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">MyBeanDefinition</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">beanDefinitionMap</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
            <span class="nc">MyBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">getScope</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"singleton"</span><span class="o">)){</span>
                <span class="c1">//如果是单例bean，就要创建一个bean</span>
                <span class="nc">Object</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">createBean</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">);</span>
                <span class="n">singletonObjects</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span><span class="n">bean</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">createBean</span><span class="o">(</span><span class="nc">MyBeanDefinition</span> <span class="n">beanDefinition</span><span class="o">){</span>
        <span class="nc">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="n">beanDefinition</span><span class="o">.</span><span class="na">getClazz</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getDeclaredConstructor</span><span class="o">().</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InstantiationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">scan</span><span class="o">(</span><span class="nc">Class</span> <span class="n">configClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyComponentScan</span> <span class="n">myComponentScanAnno</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyComponentScan</span><span class="o">)</span> <span class="n">configClass</span><span class="o">.</span><span class="na">getDeclaredAnnotation</span><span class="o">(</span><span class="nc">MyComponentScan</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//获取注解上的属性,即扫描路径</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">myComponentScanAnno</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"."</span><span class="o">,</span><span class="s">"/"</span><span class="o">);</span>
        <span class="c1">//扫描，利用类加载器才能获取某一个类上的注解，这样才能扫描到应该扫描的bean</span>
        <span class="c1">//类加载器有3中：BootStrap,Ext,App</span>
        <span class="c1">//BootStrap路径：jre/lib</span>
        <span class="c1">//Ext路径：jre/ext/lib</span>
        <span class="c1">//App路径：classpath</span>
        <span class="nc">ClassLoader</span> <span class="n">classLoader</span> <span class="o">=</span> <span class="nc">MyApplicationContext</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span><span class="c1">// App应用类加载器</span>
        <span class="no">URL</span> <span class="n">resource</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">getResource</span><span class="o">(</span><span class="n">path</span><span class="o">);</span><span class="c1">//相对路径</span>
        <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">resource</span><span class="o">.</span><span class="na">getFile</span><span class="o">());</span><span class="c1">//获取目录</span>
        <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">()){</span><span class="c1">//是一个目录</span>
            <span class="nc">File</span><span class="o">[]</span> <span class="n">files</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span><span class="c1">//获取目录下所有的文件</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">File</span> <span class="n">f</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">fileAllName</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">fileAllName</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".class"</span><span class="o">)){</span><span class="c1">//判断是不是class文件</span>
                    <span class="c1">//获取全路径名，比如：com.bones.service.EmpService.class</span>
                    <span class="nc">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">fileAllName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">fileAllName</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"com"</span><span class="o">),</span><span class="n">fileAllName</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">".class"</span><span class="o">));</span>
                    <span class="n">className</span> <span class="o">=</span> <span class="n">className</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"/"</span><span class="o">,</span> <span class="s">"."</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">classLoader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">aClass</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">MyComponent</span><span class="o">.</span><span class="na">class</span><span class="o">)){</span>
                            <span class="c1">//这里暂且不考虑懒加载</span>
                            <span class="c1">//当前这个类是一个bean,创建一个bean对象</span>
                            <span class="c1">//解析类，判断bean到底是单例的还是原型的，如果是单例的，就应该放入单例池中，如果是原型bean就不应该放入</span>
                            <span class="c1">//解析类做的就是生成一个BeanDefinition对象</span>
                            <span class="c1">//beanDefinition,spring核心概念，不用反复解析某一个类（否则下面的getBean方法也会要解析类，这样做就太麻烦了）</span>
                            <span class="nc">MyComponent</span> <span class="n">componentAnno</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredAnnotation</span><span class="o">(</span><span class="nc">MyComponent</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                            <span class="nc">String</span> <span class="n">beanName</span> <span class="o">=</span> <span class="n">componentAnno</span><span class="o">.</span><span class="na">value</span><span class="o">();</span>

                            <span class="nc">MyBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyBeanDefinition</span><span class="o">();</span>
                            <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setClazz</span><span class="o">(</span><span class="n">aClass</span><span class="o">);</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">aClass</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="nc">MyScope</span><span class="o">.</span><span class="na">class</span><span class="o">)){</span><span class="c1">//原型</span>
                                <span class="nc">MyScope</span> <span class="n">scopeAnno</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredAnnotation</span><span class="o">(</span><span class="nc">MyScope</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                                <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="n">scopeAnno</span><span class="o">.</span><span class="na">value</span><span class="o">());</span>
                            <span class="o">}</span><span class="k">else</span> <span class="o">{</span><span class="c1">//否则就是单例</span>
                                <span class="n">beanDefinition</span><span class="o">.</span><span class="na">setScope</span><span class="o">(</span><span class="s">"singleton"</span><span class="o">);</span>
                            <span class="o">}</span>
                            <span class="c1">//存储beanDefinition到beanDefinitionMap中</span>
                            <span class="n">beanDefinitionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">beanName</span><span class="o">,</span><span class="n">beanDefinition</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
                    <span class="o">}</span>

                <span class="o">}</span>


            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 获取bean
     * @param beanName  要获取的bean的名称
     * @return  返回Bean对象
     */</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="nc">String</span> <span class="n">beanName</span><span class="o">){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinitionMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">beanName</span><span class="o">)){</span><span class="c1">//当前要获取的bean对象是beanDefinitionMap中已经有的</span>
            <span class="nc">MyBeanDefinition</span> <span class="n">beanDefinition</span> <span class="o">=</span> <span class="n">beanDefinitionMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">beanDefinition</span><span class="o">.</span><span class="na">getScope</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"singleton"</span><span class="o">)){</span>
                <span class="c1">//是单例bean,从单例池中拿这个bean</span>
                <span class="k">return</span> <span class="n">singletonObjects</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">beanName</span><span class="o">);</span>

            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="c1">//原型bean,需要创建一个bean对象</span>
                <span class="k">return</span> <span class="nf">createBean</span><span class="o">(</span><span class="n">beanDefinition</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span><span class="c1">//不存在这个bean</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"不存在对应的bean："</span><span class="o">+</span><span class="n">beanName</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="0x05_测试单例bean和原型bean的获取">0x05_测试单例Bean和原型bean的获取</h2>

<p>测试类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.bones</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.myspring.MyApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.bones.config.AppConfig</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyApplicationContext</span><span class="o">(</span><span class="nc">AppConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"EmpServiceImpl"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"EmpServiceImpl"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"EmpServiceImpl"</span><span class="o">));</span>

    <span class="o">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>对于一个要注入容器的bean</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">com.bones.service</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.myspring.annotation.MyComponent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.myspring.annotation.MyScope</span><span class="o">;</span>

<span class="nd">@MyComponent</span><span class="o">(</span><span class="s">"EmpServiceImpl"</span><span class="o">)</span>
<span class="c1">//@MyScope("prototype")</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmpServiceImpl</span> <span class="kd">implements</span> <span class="nc">EmpService</span> <span class="o">{</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>首先注释掉<code class="language-plaintext highlighter-rouge">@MyScope("prototype")</code>,表示要获取的是单例的bean，</p>

<p>得到控制台的打印：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20221203222608603.png" alt="image-20221203222608603" style="zoom:50%;" /></p>

<p>打开注解<code class="language-plaintext highlighter-rouge">@MyScope("prototype")</code>,再次测试：</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20221203222644468.png" alt="image-20221203222644468" style="zoom:50%;" /></p>

<p>得到的bean都是原型bean</p>

<h2 id="0x06_核心概念beandefinition">0x06_核心概念：BeanDefinition</h2>

<p>上面的代码中核心概念就是<code class="language-plaintext highlighter-rouge">BeanDefinition</code></p>

<h3 id="什么是beandefinition">什么是BeanDefinition</h3>

<p>官网有以下介绍：</p>

<blockquote>
  <p>SpringIoc容器管理一个Bean或多个Bean，这些<strong>Bean通过我们提供给容器的配置元数据被创建出来</strong>（例如，在xml中的定义）
在容器中，这些<strong>Bean的定义用BeanDefinition对象来表示，包含以下元数据：</strong></p>

  <ul>
    <li>全限定类名， 通常是Bean的实际实现类；（就是上面代码中的<code class="language-plaintext highlighter-rouge">private Class clazz;</code>）</li>
    <li>Bean行为配置元素，它们说明Bean在容器中的行为（作用域、生命周期回调等等）；(上面代码中只涉及了Scope这个属性)</li>
    <li>Bean执行工作所需要的的其他Bean的引用，这些Bean也称为协作者或依赖项；</li>
    <li>其他配置信息，例如，管理连接池的bean中，限制池的大小或者使用的连接的数量。</li>
  </ul>
</blockquote>

<p>Spring官网中对BeanDefinition的解释还是很详细的，但是不是那么通俗易懂，其实BeanDefinition是比较容易解释的：BeanDefinition就是用来<strong>描述一个Bean或者BeanDefinition就是Bean的定义</strong>，利用BeanDefinition，可以用反射来创建bean.</p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20221203223107304.png" alt="image-20221203223107304" /></p>

<p><img src="https://wechat01.oss-cn-hangzhou.aliyuncs.com/img/image-20221203223153939.png" alt="image-20221203223153939" /></p>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    
                    <li class="next">
                        <a href="/2024/05/26/burpsuite/" data-toggle="tooltip" data-placement="top" title="Burpsuite">
                        Next<br>
                        <span>Burpsuite</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0109" 
                    href="/archive/?tag=%E4%B9%A6%E7%B1%8D%E9%98%85%E8%AF%BB"
                    title="书籍阅读"
                    rel="3">书籍阅读</a>
        
                <a data-sort="0088" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="24">算法</a>
        
                <a data-sort="0094" 
                    href="/archive/?tag=%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BDAI%E5%9F%BA%E7%A1%80"
                    title="人工智能AI基础"
                    rel="18">人工智能AI基础</a>
        
                <a data-sort="0095" 
                    href="/archive/?tag=python%E5%9F%BA%E7%A1%80"
                    title="python基础"
                    rel="17">python基础</a>
        
                <a data-sort="0100" 
                    href="/archive/?tag=%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0-%E5%90%B4%E6%81%A9%E8%BE%BE"
                    title="机器学习-吴恩达"
                    rel="12">机器学习-吴恩达</a>
        
                <a data-sort="0102" 
                    href="/archive/?tag=%E5%8A%9B%E6%89%A3"
                    title="力扣"
                    rel="10">力扣</a>
        
                <a data-sort="0107" 
                    href="/archive/?tag=numpy"
                    title="numpy"
                    rel="5">numpy</a>
        
                <a data-sort="0109" 
                    href="/archive/?tag=spring6"
                    title="spring6"
                    rel="3">spring6</a>
        
                <a data-sort="0110" 
                    href="/archive/?tag=Java%E5%9F%BA%E7%A1%80"
                    title="Java基础"
                    rel="2">Java基础</a>
        
                <a data-sort="0110" 
                    href="/archive/?tag=ollama%E5%B7%A5%E5%85%B7"
                    title="ollama工具"
                    rel="2">ollama工具</a>
        
                <a data-sort="0110" 
                    href="/archive/?tag=pandas"
                    title="pandas"
                    rel="2">pandas</a>
        
                <a data-sort="0110" 
                    href="/archive/?tag=python%E7%88%AC%E8%99%AB"
                    title="python爬虫"
                    rel="2">python爬虫</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://m.freebuf.com/">freebuf</a></li>
  
  <li><a href="https://xz.aliyun.com/">先知</a></li>
  
  <li><a href="https://www.sec-in.com/All">sec-in</a></li>
  
  <li><a href="https://paper.seebug.org/">see-bug</a></li>
  
  <li><a href="https://twitter.com/Concurr21486093">我的推特</a></li>
  
  <li><a href="https://pdai.tech/">pdai</a></li>
  
  <li><a href="https://nodejs.org/dist/">nodejs index of dist</a></li>
  
  <li><a href="#">公众号：小东方不败</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  <li>
    <a href="https://twitter.com/Concurr21486093">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.zhihu.com/people/Hilda">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa  fa-stack-1x fa-inverse">知</i>
      </span>
    </a>
  </li>
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/kirsten-1">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Hilda 2025
                    <br>
                    Powered by <a href="https://kirsten-1.github.io/">hilda Blog</a>
<!--                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"-->
<!--                        height="20px"-->
<!--                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">-->
<!--                    </iframe>-->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
